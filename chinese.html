<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹æ–‡ä¹å¼ãƒ»é™é­”ä¿®ç…‰è·¯ V4</title>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Zen+Maru+Gothic:wght@500;700&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #111;
            color: #eee;
            overscroll-behavior: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            /* èƒŒæ™¯ç´‹ç† */
            background-image: radial-gradient(#333 1px, transparent 1px);
            background-size: 20px 20px;
        }

        /* --- è¦–è¦ºç‰¹æ•ˆ --- */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px) rotate(-5deg); }
            75% { transform: translateX(5px) rotate(5deg); }
        }
        .shake-effect { animation: shake 0.4s ease-in-out; border: 2px solid #ef4444 !important; }

        @keyframes pop {
            0% { transform: scale(0.8); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-in { animation: pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        @keyframes floatText {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-50px); opacity: 0; }
        }
        .damage-float {
            position: absolute;
            color: #ef4444;
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 2px 2px 0 #fff;
            animation: floatText 1s ease-out forwards;
            pointer-events: none;
            z-index: 100;
            left: 50%;
            top: 30%;
            transform: translateX(-50%);
        }

        /* æ€ªç‰©å‘¼å¸ */
        .monster-idle { animation: breath 3s infinite ease-in-out; }
        @keyframes breath { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }

        /* é‡é»æ¨™ç¤º */
        .highlight { background: linear-gradient(120deg, #84cc16 0%, #10b981 100%); color: black; padding: 2px 5px; border-radius: 4px; font-weight: bold; }
        .dim { text-decoration: line-through; color: #666; }
        .cut { border-right: 3px solid red; padding-right: 5px; margin-right: 5px; }
        
        /* éš±è—/é¡¯ç¤ºæ§åˆ¶ */
        .hidden { display: none !important; }
    </style>
</head>
<body class="h-screen w-screen flex flex-col items-center justify-center">

    <div id="game-container" class="w-full max-w-md h-full flex flex-col relative bg-gray-900 shadow-2xl overflow-hidden">
        
        <div id="menu-screen" class="absolute inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-6 text-center">
            <h1 class="text-5xl font-black text-yellow-500 mb-2 pop-in">åœ‹æ–‡ä¹å¼</h1>
            <h2 class="text-3xl font-bold text-red-500 mb-8 pop-in" style="animation-delay: 0.2s">é™é­”ä¿®ç…‰è·¯</h2>
            <div class="space-y-4 w-full">
                <button onclick="startGame()" class="w-full bg-red-600 hover:bg-red-500 text-white text-2xl font-bold py-4 rounded-xl shadow-lg transform active:scale-95 transition-all">
                    âš¡ é–‹å§‹ä¿®ç…‰
                </button>
            </div>
            <p class="mt-8 text-gray-500 text-sm">V4.0 Native Stable</p>
        </div>

        <div id="battle-screen" class="hidden flex-col h-full">
            <div class="p-3 bg-gray-800 border-b border-gray-700 flex justify-between items-center z-10">
                <div class="flex gap-1" id="hp-container">
                    </div>
                <div id="level-name" class="font-bold text-yellow-500">é—œå¡åç¨±</div>
            </div>

            <div class="flex-1 bg-gray-900 relative flex flex-col items-center justify-center p-4">
                <div id="damage-overlay"></div>
                
                <div id="monster-visual" class="mb-6 monster-idle transition-all duration-200">
                    <div class="w-32 h-32 bg-gray-800 rounded-full border-4 border-gray-600 flex items-center justify-center text-6xl shadow-[0_0_30px_rgba(255,255,255,0.1)] relative overflow-hidden">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                        <span id="monster-icon">ğŸ‘¹</span>
                    </div>
                </div>

                <div class="w-64 h-4 bg-gray-800 rounded-full border border-gray-600 overflow-hidden relative">
                    <div id="hp-bar" class="h-full bg-red-600 transition-all duration-500" style="width: 100%"></div>
                </div>
                <div id="enemy-name" class="mt-2 text-gray-400 font-bold">æ€ªç‰©åç¨±</div>
            </div>

            <div class="bg-[#1a1a1a] border-t-4 border-yellow-700 flex flex-col h-[55%] shadow-[0_-5px_20px_rgba(0,0,0,0.8)] z-20">
                <div class="flex-1 overflow-y-auto p-4">
                    <div class="bg-[#2a2a2a] p-4 rounded-lg border border-gray-600 shadow-inner">
                        <div class="flex justify-between text-xs text-yellow-500 mb-2 border-b border-gray-600 pb-2">
                            <span id="question-source">ä¾†æº</span>
                            <span id="question-title">ç¯‡å</span>
                        </div>
                        <div id="question-content" class="text-lg leading-loose text-gray-300 text-justify">
                            æ–‡ç« å…§å®¹...
                        </div>
                    </div>
                </div>

                <div class="p-3 bg-gray-800 border-t border-gray-700">
                    <div id="feedback-area" class="hidden absolute top-[-60px] left-1/2 transform -translate-x-1/2 bg-black/90 text-white px-6 py-2 rounded-full border border-yellow-500 font-bold animate-bounce whitespace-nowrap z-50">
                        åé¥‹è¨Šæ¯
                    </div>

                    <div id="phase-intro" class="text-center py-4">
                        <p id="skill-desc" class="text-gray-400 mb-4">æŠ€èƒ½èªªæ˜</p>
                        <button onclick="enterSkillPhase()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow-lg active:scale-95 transition-transform flex items-center justify-center gap-2">
                            <span>ğŸ‘ï¸</span> <span id="skill-btn-text">ç™¼å‹•æŠ€èƒ½</span>
                        </button>
                    </div>

                    <div id="phase-skill" class="hidden space-y-2">
                        <div class="text-blue-400 font-bold mb-2 text-sm" id="pre-question-text">æŠ€èƒ½å•é¡Œ</div>
                        <div id="skill-options" class="grid gap-2"></div>
                    </div>

                    <div id="phase-attack" class="hidden space-y-2">
                        <div class="text-red-400 font-bold mb-2 text-sm" id="final-question-text">çµ‚çµå•é¡Œ</div>
                        <div id="attack-options" class="grid gap-2"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="end-screen" class="hidden absolute inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-6 text-center">
            <div id="end-icon" class="text-8xl mb-4">ğŸ†</div>
            <h1 id="end-title" class="text-4xl font-bold text-yellow-400 mb-4">ä¿®ç…‰å®Œæˆ</h1>
            <button onclick="location.reload()" class="bg-gray-700 text-white px-8 py-3 rounded-full font-bold text-xl hover:bg-gray-600 border border-gray-500">
                é‡æ–°é–‹å§‹
            </button>
        </div>

    </div>

    <script>
        // è³‡æ–™åº«
        const LEVELS = [
            {
                id: 1, name: "ç¬¬ä¸€é—œï¼šè¿·éœ§æ£®æ—", skill: "æ…§çœ¼è­˜é¡Œ", desc: "å¿…å‹ç¬¬ä¸€å¼ï¼šå…ˆçœ‹ç¯‡åï¼Œé æ¸¬ä¸»æ—¨ï¼", color: "text-emerald-400",
                enemies: [
                    {
                        name: "èŒ¶é¦™éœ§å¦–", type: "å°æ€ª", hp: 100, source: "109å¹´æœƒè€ƒ Q33", title: "ã€ˆå–èŒ¶åŠ ä¸åŠ ç³–ï¼ŒåŸä¾†å’Œéšç´šæœ‰é—œã€‰",
                        content: "å–èŒ¶åŠ æª¸æª¬æ˜¯ç¾å¼ä½œæ³•ï¼Œè‹±åœ‹äººå‰‡ä¸ç„¶...ä¸­ä¸Šéšç´šçš„å–èŒ¶ç¿’æ…£...è€Œå‹å‹•éšç´šçš„é£²èŒ¶æ–¹å¼ï¼Œå‰‡æ˜¯ä»¥èŒ¶åŒ…æ²–æ³¡æ–¼é¦¬å…‹æ¯ä¸­å½¢æˆæ¿ƒèŒ¶å¾Œå†åŠ å…¥ç³–...",
                        targets: ["å‹å‹•éšç´š", "é¦¬å…‹æ¯", "æ¿ƒèŒ¶", "åŠ å…¥ç³–"], style: "highlight",
                        preQ: "é€™ç¯‡æ–‡ç« çš„ä¸»æ—¨åœ¨è¬›ä»€éº¼ï¼Ÿ", preOpts: ["èŒ¶è‘‰ç¨®æ¤æŠ€è¡“", "éšç´šèˆ‡å–èŒ¶ç¿’æ…£"], preAns: 1,
                        finalQ: "æ˜”æ—¥è‹±åœ‹ã€Œå‹å‹•éšç´šã€çš„å–èŒ¶æ–¹å¼ï¼Ÿ", finalOpts: ["ç“·å™¨æ·¡èŒ¶ä¸åŠ ç³–", "é¦¬å…‹æ¯æ¿ƒèŒ¶åŠ ç³–", "ç“·å™¨æ¿ƒèŒ¶åŠ ç³–", "é¦¬å…‹æ¯æ·¡èŒ¶ä¸åŠ ç³–"], finalAns: 1
                    },
                    {
                        name: "å›æ†¶æ¨¹ç²¾", type: "èè‹±", hp: 200, source: "105å¹´æœƒè€ƒ Q42", title: "å‘é™½ã€ˆå°æ²³ã€‰",
                        content: "å°æ²³å‘¢ï¼Ÿé‚£å¿µå¿µä¸å¿˜çš„å°æ²³...ä¹¾ç™Ÿã€ç˜¦å‰Šï¼Œè€Œä¸”çœ‹ä¾†ç—›è‹¦...å †ç©è‘—ç ´éŠ…çˆ›éµï¼Œç´™å¼µåƒåœ¾...",
                        targets: ["ä¹¾ç™Ÿã€ç˜¦å‰Š", "ç—›è‹¦", "å †ç©è‘—ç ´éŠ…çˆ›éµ"], style: "highlight",
                        preQ: "é€™é¦–è©©çš„ä¸»è§’æ˜¯ï¼Ÿ", preOpts: ["æŸå€‹äºº", "ä¸€æ¢æ²³"], preAns: 1,
                        finalQ: "ã€ä¹¾ç™Ÿã€ç˜¦å‰Šã€éš±å«ä»€éº¼å¿ƒæƒ…ï¼Ÿ", finalOpts: ["é©šæ„•èˆ‡å¤±è½", "æ†¤æ€’èˆ‡ä»‡æ¨", "å¹³éœèˆ‡æ¥ç´", "èˆˆå¥®èˆ‡æœŸå¾…"], finalAns: 0
                    },
                    {
                        name: "ç¦®æ•™çŸ³åƒ", type: "BOSS", hp: 300, source: "110å¹´æœƒè€ƒ Q40", title: "å¸é¦¬å…‰ã€ˆç­”è–›è™Ÿå·è¬çŸ³æœˆå±æ›¸ã€‰",
                        content: "æ—¥å‰ä»¤éƒè¨ªé€®ï¼Œå‡ºæ‰‹ç­†ä¸¦çŸ³æœˆå±ç‚ºè´ˆ...æ¯”ä¾†ï¼Œæ•¸æ–¼éƒ½ä¸‹æœ‹å¾è™•è¦‹æ­¤å±...",
                        targets: ["ç­”", "è¬", "ä»¤éƒ"], style: "highlight",
                        preQ: "é€™ç¯‡æ–‡ç« çš„ç›®çš„æ˜¯ï¼Ÿ", preOpts: ["è¨å‚µ", "ç­”è¬ç¦®ç‰©"], preAns: 1,
                        finalQ: "æ–‡ä¸­ã€ä»¤éƒã€æ˜¯æŒ‡èª°ï¼Ÿ", finalOpts: ["è–›è™Ÿå·çš„å…’å­", "å¸é¦¬å…‰çš„å…’å­", "çŸ³æœˆå±çš„ä½œè€…", "é€ç¦®çš„åƒ•äºº"], finalAns: 0
                    }
                ]
            },
            {
                id: 2, name: "ç¬¬äºŒé—œï¼šæ–·å¥å³½è°·", skill: "æ–·å¥æ–¬", desc: "å¿…å‹ç¬¬äºŒå¼ï¼šæ–¬æ–·é•·å¥ï¼Œæ‰¾å‡ºèªæ°£ï¼", color: "text-red-400",
                enemies: [
                    {
                        name: "é•·å¥å·¨èŸ’", type: "èè‹±", hp: 150, source: "111å¹´æœƒè€ƒ Q7", title: "è¨˜æ†¶èˆ‡æ•˜è¿°",
                        content: "æ•˜è¿°è¨˜æ†¶æ˜¯ä»¶é›£äº‹...å°±ç®—æ‹¼æ¹Šèµ·ä¾†äº†ä¹™ä¹Ÿåªç®—æ˜¯æ­»çš„æ¨™æœ¬...è¦æƒ³å°‡é¢¨ç‰‡åˆ‡ä¸‹ä¾†ï¼Œè±ˆä¸å®Œå…¨æ˜¯ä¸€å ´å¾’å‹å—ä¸",
                        targets: ["ä¸"], style: "cut",
                        preQ: "ã€Œè±ˆä¸å®Œå…¨æ˜¯ä¸€å ´å¾’å‹å—ã€èªæ°£ç‚ºä½•ï¼Ÿ", preOpts: ["è‚¯å®šå¥", "åå•å¥"], preAns: 1,
                        finalQ: "ç”²ä¹™ä¸™ä¸ä½•è™•æœ€é©åˆå¡«å…¥ã€å¥è™Ÿã€ï¼Ÿ", finalOpts: ["ç”²", "ä¹™", "ä¸™", "ä¸"], finalAns: 3
                    },
                    {
                        name: "é›™é ­çµäºº", type: "BOSS", hp: 300, source: "106å¹´æœƒè€ƒ Q35", title: "çµäººèˆ‡è¾²å¤«",
                        content: "ç¾åœ¨æ‰€è¬‚æ³¨æ„åŠ›ç¼ºå¤±è€…çš„ç‰¹å¾µâ€”â€”å®¹æ˜“åˆ†å¿ƒã€è¡å‹•ã€å†’éšªæ€§å¼·ï¼Œå…¶å¯¦æ˜¯é å¤æ‰“çµæ¡é›†æ™‚ç”Ÿå­˜å¿…è¦çš„ç‰¹å¾µ...",
                        targets: ["â€”â€”", "ç‰¹å¾µ"], style: "highlight",
                        preQ: "ç ´æŠ˜è™Ÿ (â€”â€”) çš„åŠŸèƒ½æ˜¯ï¼Ÿ", preOpts: ["è²éŸ³å»¶é•·", "è§£é‡‹èªªæ˜"], preAns: 1,
                        finalQ: "ä½œè€…å°ADHDè€…çš„æ ¸å¿ƒçœ‹æ³•ï¼Ÿ", finalOpts: ["æ‡‰æ¥å—æ²»ç™‚", "ä¸å®œä»¥ç•°é¡çœ¼å…‰çœ‹å¾…", "åŸºå› æ¯”å¸¸äººå„ªç§€", "æ˜¯ç¤¾æœƒçš„è² æ“”"], finalAns: 1
                    }
                ]
            },
            {
                id: 3, name: "ç¬¬ä¸‰é—œï¼šé‚è¼¯è¿·å®®", skill: "è½‰æŠ˜ç›¾", desc: "å¿…å‹ç¬¬ä¸‰å¼ï¼šæ“‹æ‰å»¢è©±ï¼Œç•™ä¸‹é‡é»ï¼", color: "text-blue-400",
                enemies: [
                    {
                        name: "æ²¸æ°´æ€ª", type: "å°æ€ª", hp: 120, source: "105å¹´æœƒè€ƒ Q31", title: "æšæ¹¯æ­¢æ²¸",
                        content: "æšæ¹¯ä»¥æ­¢æ²¸ï¼Œä¸å¦‚çµ•å…¶è–ªè€Œæ²¸æ­¢ä¹‹é€Ÿä¹Ÿã€‚æ˜¯ä»¥å‹å¿ƒæ–¼æœé è€…ï¼Œè«è‹¥ä¿®è¿‘è€Œå…¶é è‡ªä¾†...",
                        targets: ["æšæ¹¯ä»¥æ­¢æ²¸"], style: "dim",
                        preQ: "ã€Œä¸å¦‚ã€å‡ºç¾æ™‚ï¼Œé‡é»åœ¨ï¼Ÿ", preOpts: ["å‰é¢ (æšæ¹¯æ­¢æ²¸)", "å¾Œé¢ (çµ•è–ª)"], preAns: 1,
                        finalQ: "ä½•è€…æœ€ç¬¦åˆä½œè€…ã€Œæ²»æœ¬ã€è§€é»ï¼Ÿ", finalOpts: ["æšæ¹¯æ­¢æ²¸", "æŠ•è† è®Šæ¿", "çµ•è–ªæ­¢æ²¸", "å¤šæ–¹æ•‘å¤±"], finalAns: 2
                    },
                    {
                        name: "æ·±å½é­”ç‹", type: "BOSS", hp: 400, source: "113å¹´æœƒè€ƒ Q35", title: "æ·±å½æŠ€è¡“",
                        content: "è‹¥å°‡å®ƒé‹ç”¨æ–¼å½±è¦–ä½œå“...æœ‰æ­£é¢çš„æ•ˆç›Šã€‚ä½†ä¹Ÿæœ‰äººåˆ©ç”¨åˆæˆçš„å‡å½±åƒæ“å¼„è³‡è¨Šï¼Œé€²è€Œè©é¨™ç‰Ÿåˆ©...",
                        targets: ["æœ‰æ­£é¢çš„æ•ˆç›Š"], style: "dim",
                        preQ: "ä½œè€…ç”¨ã€Œä½†ã€ï¼Œæƒ³å¼·èª¿çš„æ˜¯ï¼Ÿ", preOpts: ["æ­£é¢æ•ˆç›Š", "è² é¢çˆ­è­°"], preAns: 1,
                        finalQ: "æ·±å½æŠ€è¡“æœ€å¤§çš„éš±æ†‚æ˜¯ä»€éº¼ï¼Ÿ", finalOpts: ["æˆæœ¬éé«˜", "å–ä»£æ¼”å“¡å·¥ä½œ", "é€ æˆç¤¾æœƒä¸ä¿¡ä»»", "æŠ€è¡“é–€æª»å¤ªä½"], finalAns: 2
                    }
                ]
            }
        ];

        // éŠæˆ²ç‹€æ…‹
        let currentLevelIdx = 0;
        let currentEnemyIdx = 0;
        let hp = 3;
        let enemyHp = 100;
        let maxEnemyHp = 100;

        // åˆå§‹åŒ–
        function startGame() {
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('battle-screen').classList.remove('hidden');
            document.getElementById('battle-screen').classList.add('flex');
            loadLevel();
        }

        function loadLevel() {
            const level = LEVELS[currentLevelIdx];
            const enemy = level.enemies[currentEnemyIdx];
            
            // è¨­å®šæ•¸æ“š
            document.getElementById('level-name').innerText = level.name;
            document.getElementById('enemy-name').innerText = `${enemy.name} (${enemy.type})`;
            document.getElementById('question-source').innerText = enemy.source;
            document.getElementById('question-title').innerText = enemy.title;
            document.getElementById('question-content').innerHTML = enemy.content; // é‡ç½®æ–‡å­—
            document.getElementById('monster-icon').innerText = enemy.type === 'å°æ€ª' ? 'ğŸ¦ ' : enemy.type === 'èè‹±' ? 'ğŸ' : 'ğŸ‘¹';
            document.getElementById('skill-desc').innerText = level.desc;
            document.getElementById('skill-btn-text').innerText = level.skill;
            document.getElementById('pre-question-text').innerText = enemy.preQ;
            document.getElementById('final-question-text').innerText = enemy.finalQ;

            // è¡€é‡
            enemyHp = enemy.hp;
            maxEnemyHp = enemy.hp;
            updateEnemyHpBar();
            renderPlayerHp();

            // éšæ®µé‡ç½®
            showPhase('intro');
            
            // é¸é …ç”Ÿæˆ
            renderOptions('skill-options', enemy.preOpts, handleSkill);
            renderOptions('attack-options', enemy.finalOpts, handleAttack);
        }

        function renderPlayerHp() {
            const container = document.getElementById('hp-container');
            container.innerHTML = '';
            for(let i=0; i<3; i++) {
                const heart = document.createElement('span');
                heart.innerHTML = 'â¤ï¸';
                heart.style.opacity = i < hp ? '1' : '0.2';
                heart.style.filter = i < hp ? 'none' : 'grayscale(100%)';
                container.appendChild(heart);
            }
        }

        function updateEnemyHpBar() {
            const pct = (enemyHp / maxEnemyHp) * 100;
            document.getElementById('hp-bar').style.width = `${pct}%`;
        }

        function renderOptions(containerId, options, handler) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            options.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = "w-full bg-gray-700 hover:bg-gray-600 text-white text-left py-3 px-4 rounded border border-gray-600 active:bg-gray-500 transition-colors";
                btn.innerHTML = `<span class="text-yellow-500 font-bold mr-2">${String.fromCharCode(65+idx)}.</span> ${opt}`;
                btn.onclick = () => handler(idx);
                container.appendChild(btn);
            });
        }

        function showPhase(phase) {
            document.getElementById('phase-intro').classList.add('hidden');
            document.getElementById('phase-skill').classList.add('hidden');
            document.getElementById('phase-attack').classList.add('hidden');
            
            if(phase === 'intro') document.getElementById('phase-intro').classList.remove('hidden');
            if(phase === 'skill') document.getElementById('phase-skill').classList.remove('hidden');
            if(phase === 'attack') document.getElementById('phase-attack').classList.remove('hidden');
        }

        function enterSkillPhase() {
            showPhase('skill');
        }

        function showFeedback(msg, isGood) {
            const fb = document.getElementById('feedback-area');
            fb.innerText = msg;
            fb.classList.remove('hidden');
            fb.style.borderColor = isGood ? '#22c55e' : '#ef4444';
            setTimeout(() => fb.classList.add('hidden'), 1500);
        }

        function triggerShake() {
            const container = document.getElementById('game-container');
            container.classList.add('shake-effect');
            setTimeout(() => container.classList.remove('shake-effect'), 400);
        }

        function showDamageText(text) {
            const el = document.createElement('div');
            el.innerText = text;
            el.className = 'damage-float';
            document.getElementById('game-container').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // --- æ ¸å¿ƒäº’å‹• ---

        function handleSkill(idx) {
            const enemy = LEVELS[currentLevelIdx].enemies[currentEnemyIdx];
            if (idx === enemy.preAns) {
                showFeedback("âœ… æŠ€èƒ½ç™¼å‹•æˆåŠŸï¼", true);
                showDamageText("ç ´é˜²!");
                
                // æ–‡å­—ç‰¹æ•ˆ
                let text = enemy.content;
                const targets = Array.isArray(enemy.targets) ? enemy.targets : [enemy.targets];
                
                targets.forEach(t => {
                    let replaceHtml = '';
                    if(enemy.style === 'highlight') replaceHtml = `<span class="highlight">${t}</span>`;
                    else if(enemy.style === 'dim') replaceHtml = `<span class="dim">${t}</span>`;
                    else if(enemy.style === 'cut') replaceHtml = `<span class="cut"></span><span class="text-red-400 font-bold">${t}</span>`;
                    
                    text = text.replace(new RegExp(t, 'g'), replaceHtml);
                });
                
                document.getElementById('question-content').innerHTML = text;
                
                setTimeout(() => showPhase('attack'), 1000);
            } else {
                handleError();
            }
        }

        function handleAttack(idx) {
            const enemy = LEVELS[currentLevelIdx].enemies[currentEnemyIdx];
            if (idx === enemy.finalAns) {
                showFeedback("âš”ï¸ æœƒå¿ƒä¸€æ“Šï¼", true);
                showDamageText("-" + enemyHp);
                enemyHp = 0;
                updateEnemyHpBar();
                
                // æ€ªç‰©å—å‚·å‹•ç•«
                const monster = document.getElementById('monster-visual');
                monster.style.transform = 'scale(0.8) rotate(10deg)';
                monster.style.filter = 'grayscale(100%) brightness(0.5)';

                setTimeout(() => {
                    monster.style.transform = '';
                    monster.style.filter = '';
                    nextLevel();
                }, 1500);
            } else {
                handleError();
            }
        }

        function handleError() {
            triggerShake();
            showFeedback("âŒ åˆ¤æ–·éŒ¯èª¤ï¼", false);
            hp--;
            renderPlayerHp();
            if (hp <= 0) {
                setTimeout(() => {
                    document.getElementById('battle-screen').classList.add('hidden');
                    document.getElementById('end-screen').classList.remove('hidden');
                    document.getElementById('end-title').innerText = "ä¿®ç…‰å¤±æ•—...";
                    document.getElementById('end-title').className = "text-4xl font-bold text-red-500 mb-4";
                    document.getElementById('end-icon').innerText = "ğŸ’€";
                }, 1000);
            }
        }

        function nextLevel() {
            const currentLevel = LEVELS[currentLevelIdx];
            if (currentEnemyIdx < currentLevel.enemies.length - 1) {
                currentEnemyIdx++;
                loadLevel();
            } else {
                if (currentLevelIdx < LEVELS.length - 1) {
                    currentLevelIdx++;
                    currentEnemyIdx = 0;
                    loadLevel();
                } else {
                    // å…¨é€šé—œ
                    document.getElementById('battle-screen').classList.add('hidden');
                    document.getElementById('end-screen').classList.remove('hidden');
                }
            }
        }
    </script>
</body>
</html>
