<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åœ‹æ–‡ä¹å¼ãƒ»é™é­”ä¿®ç…‰è·¯ V3</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700;900&family=Zen+Maru+Gothic:wght@500;700&display=swap');
        
        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #0f0f0f;
            color: #e5e5e5;
            overscroll-behavior: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        /* æˆ°é¬¥ç‰¹æ•ˆ */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            100% { transform: translate(0, 0) rotate(0deg); }
        }

        .screen-shake {
            animation: shake 0.5s;
            border: 2px solid red;
        }

        @keyframes damage-float {
            0% { opacity: 1; transform: translateY(0) scale(1); }
            100% { opacity: 0; transform: translateY(-50px) scale(1.5); }
        }

        .damage-text {
            position: absolute;
            color: #ef4444;
            font-size: 3rem;
            font-weight: 900;
            text-shadow: 2px 2px 0 #000;
            animation: damage-float 1s ease-out forwards;
            pointer-events: none;
            z-index: 50;
        }

        @keyframes monster-breath {
            0% { transform: scale(1); filter: brightness(1); }
            50% { transform: scale(1.05); filter: brightness(1.2); }
            100% { transform: scale(1); filter: brightness(1); }
        }

        .monster-idle {
            animation: monster-breath 3s infinite ease-in-out;
        }

        .monster-hit {
            filter: sepia(1) saturate(1000%) hue-rotate(-50deg) brightness(0.8);
            transform: scale(0.9);
            transition: all 0.1s;
        }

        /* é‡é»æ¨™ç¤º */
        .highlight-text {
            background: linear-gradient(120deg, #84cc16 0%, #10b981 100%);
            color: #000;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: bold;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.5);
        }

        .dim-text {
            color: #555;
            text-decoration: line-through;
            font-size: 0.9em;
        }

        .cut-mark {
            display: inline-block;
            width: 4px;
            height: 1.2em;
            background-color: #ef4444;
            margin: 0 4px;
            vertical-align: middle;
            box-shadow: 0 0 8px #ef4444;
            transform: rotate(15deg);
        }
    </style>
</head>
<body class="h-screen w-screen overflow-hidden flex flex-col">
    <div id="root" class="h-full w-full max-w-lg mx-auto flex flex-col relative"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { Sword, Shield, Eye, BookOpen, Skull, Zap, Heart, BarChart2 } = lucide;

        // --- å®Œæ•´é¡Œåº«è³‡æ–™åº« ---
        const LEVELS = [
            {
                id: 1,
                name: "ç¬¬ä¸€é—œï¼šè¿·éœ§æ£®æ—",
                skill: "æ…§çœ¼è­˜é¡Œ",
                icon: <Eye className="w-6 h-6 text-yellow-300" />,
                desc: "å¿…å‹ç¬¬ä¸€å¼ï¼šç¯‡åå‘¼æ‡‰ã€‚å…ˆçœ‹ç¯‡åï¼Œé æ¸¬ä¸»æ—¨ï¼",
                bossColor: "bg-emerald-600",
                enemies: [
                    {
                        name: "èŒ¶é¦™éœ§å¦–",
                        type: "å°æ€ª",
                        hp: 100,
                        source: "109å¹´æœƒè€ƒ Q33",
                        title: "ã€ˆå–èŒ¶åŠ ä¸åŠ ç³–ï¼ŒåŸä¾†å’Œéšç´šæœ‰é—œã€‰",
                        // å®Œæ•´åŸæ–‡
                        content: "å–èŒ¶åŠ æª¸æª¬æ˜¯ç¾å¼ä½œæ³•ï¼Œè‹±åœ‹äººå‰‡ä¸ç„¶ã€‚æ—©æœŸé–‹å§‹æµè¡ŒèŒ¶è‘‰æ™‚ï¼Œè‹±åœ‹äººæ¨¡ä»¿ä¸­åœ‹äººä½¿ç”¨ç“·å…·æ³¡èŒ¶ï¼Œä½†è‹¥ç›´æ¥å€’å…¥ç†±èŒ¶å¯èƒ½å°è‡´ç“·æ¯éç†±ç ´è£‚ï¼Œæ•…å…ˆåŠ å…¥ç‰›å¥¶ä¾†é™æº«...ä¸­ä¸Šéšç´šçš„å–èŒ¶ç¿’æ…£ï¼Œæ˜¯å…ˆç”¨èŒ¶å£ºæµ¸æ³¡èŒ¶è‘‰ï¼Œå½¢æˆæ·¡èŒ¶å¾Œå†å€’å…¥å–®è€³ç“·æ¯è£¡...è€Œå‹å‹•éšç´šçš„é£²èŒ¶æ–¹å¼ï¼Œå‰‡æ˜¯ä»¥èŒ¶åŒ…æ²–æ³¡æ–¼é¦¬å…‹æ¯ä¸­å½¢æˆæ¿ƒèŒ¶å¾Œå†åŠ å…¥ç³–ï¼Œç‰›å¥¶å‰‡å¯èåˆæ¿ƒèŒ¶çš„è‹¦æ¾€å‘³...",
                        skillTarget: ["å‹å‹•éšç´š", "é¦¬å…‹æ¯", "æ¿ƒèŒ¶", "åŠ å…¥ç³–"],
                        preQuestion: "æ ¹æ“šç¯‡åï¼Œé€™ç¯‡æ–‡ç« çš„æ ¸å¿ƒä¸»æ—¨æ˜¯ä»€éº¼ï¼Ÿ",
                        preOptions: ["èŒ¶è‘‰çš„ç¨®æ¤æŠ€è¡“", "éšç´šèˆ‡å–èŒ¶ç¿’æ…£çš„é—œä¿‚"],
                        preAnswer: 1,
                        finalQuestion: "æ ¹æ“šæœ¬æ–‡ï¼Œæ˜”æ—¥è‹±åœ‹ã€Œå‹å‹•éšç´šã€çš„å–èŒ¶æ–¹å¼ç‚ºä½•ï¼Ÿ",
                        options: ["ç“·å™¨ã€æ·¡èŒ¶ã€ä¸åŠ ç³–", "é¦¬å…‹æ¯ã€æ¿ƒèŒ¶ã€åŠ ç³–", "ç“·å™¨ã€æ¿ƒèŒ¶ã€åŠ ç³–", "é¦¬å…‹æ¯ã€æ·¡èŒ¶ã€ä¸åŠ ç³–"],
                        answer: 1
                    },
                    {
                        name: "å›æ†¶æ¨¹ç²¾",
                        type: "èè‹±",
                        hp: 200,
                        source: "105å¹´æœƒè€ƒ Q42",
                        title: "å‘é™½ã€ˆå°æ²³ã€‰",
                        content: "å°æ²³å‘¢ï¼Ÿé‚£å¿µå¿µä¸å¿˜çš„å°æ²³ã€‚ä¾†åˆ°æ²³åŸ”çš„æ™‚å€™ï¼Œå·²åˆæ™‚åˆ†...è€Œä»¤æˆ‘çœŸæ­£é©šæ‚¸çš„ï¼Œé‚„æ˜¯å°æ²³ã€‚ä¹¾ç™Ÿã€ç˜¦å‰Šï¼Œè€Œä¸”çœ‹ä¾†ç—›è‹¦ã€‚ä¸€æ¢ç˜¦éª¨å¶™å³‹çš„æ²³åºŠï¼å‰æ–¹æ˜¯å¯ä»¥æŒ‡èªå‡ºä¾†çš„æ´—è¡£çŸ³...å †ç©è‘—ç ´éŠ…çˆ›éµï¼Œç´™å¼µåƒåœ¾ï¼Œæ²’æœ‰æ²³æ°´ï¼Œè‡ªç„¶æ²’æœ‰é­šè¦...é€™æ¨£ä¸€æ¢å°æ²³ï¼é‚£æ›¾ç¶“å¿µå¿µä¸å¿˜çš„å°æ²³ï¼Ÿ",
                        skillTarget: ["ä¹¾ç™Ÿã€ç˜¦å‰Š", "ç—›è‹¦", "å †ç©è‘—ç ´éŠ…çˆ›éµ"],
                        preQuestion: "å¾ç¯‡åã€ˆå°æ²³ã€‰èˆ‡æ–‡å¥åˆ¤æ–·ï¼Œä¸»è§’æ˜¯ï¼Ÿ",
                        preOptions: ["ä¸€ä½è€äºº", "ä¸€æ¢æ²³æµ"],
                        preAnswer: 1,
                        finalQuestion: "æ–‡ä¸­ç•«ç·šè™•ã€ä¹¾ç™Ÿã€ç˜¦å‰Šã€éš±å«ä½œè€…ä»€éº¼å¿ƒæƒ…ï¼Ÿ",
                        options: ["é©šæ„•èˆ‡å¤±è½", "æ†¤æ€’èˆ‡ä»‡æ¨", "å¹³éœèˆ‡æ¥ç´", "èˆˆå¥®èˆ‡æœŸå¾…"],
                        answer: 0
                    }
                ]
            },
            {
                id: 2,
                name: "ç¬¬äºŒé—œï¼šæ–·å¥å³½è°·",
                skill: "æ–·å¥æ–¬",
                icon: <Sword className="w-6 h-6 text-red-400" />,
                desc: "å¿…å‹ç¬¬äºŒå¼ï¼šæ¨™é»æ–·å¥ã€‚æ–¬æ–·é•·å¥ï¼Œæ‰¾å‡ºèªæ°£ï¼",
                bossColor: "bg-red-700",
                enemies: [
                    {
                        name: "é•·å¥å·¨èŸ’",
                        type: "èè‹±",
                        hp: 150,
                        source: "111å¹´æœƒè€ƒ Q7",
                        title: "è¨˜æ†¶èˆ‡æ•˜è¿°",
                        content: "æ•˜è¿°è¨˜æ†¶æ˜¯ä»¶é›£äº‹ã€‚è¨˜æ†¶æ˜¯ä¸€å€‹æ•´é«”ï¼Œæ•˜è¿°çš„æ™‚å€™å¿…é ˆé¸æ“‡å°‡å®ƒä¸€ç‰‡ç‰‡çš„åˆ‡ä¸‹ï¼Œå³ä½¿æ˜¯ä¸€å¡Šè‚‰ã€ä¸€æ£µèœç”²åˆ‡ä¸‹ä¾†å¾Œå°±å†ä¹Ÿæ‹¼ä¸å®Œæ•´äº†ï¼Œå°±ç®—æ‹¼æ¹Šèµ·ä¾†äº†ä¹™ä¹Ÿåªç®—æ˜¯æ­»çš„æ¨™æœ¬ï¼Œç”Ÿå‘½å·²è•©ç„¶ä¸™ä½•æ³è¨˜æ†¶å¤§éƒ¨åˆ†çš„æ™‚å€™æ›´åƒä¸€é™£é¢¨ï¼Œä¾†ç„¡å½±å»ç„¡è¹¤çš„ï¼Œè¦æƒ³å°‡é¢¨ç‰‡åˆ‡ä¸‹ä¾†ï¼Œè±ˆä¸å®Œå…¨æ˜¯ä¸€å ´å¾’å‹å—ä¸",
                        skillTarget: "ä¸",
                        preQuestion: "ã€Œè±ˆä¸å®Œå…¨æ˜¯ä¸€å ´å¾’å‹å—ã€é€™æ˜¯ä»€éº¼èªæ°£ï¼Ÿ",
                        preOptions: ["è‚¯å®šå¥ (ã€‚)", "åå•å¥ (?)"],
                        preAnswer: 1,
                        finalQuestion: "æ–‡ä¸­ç”²ä¹™ä¸™ä¸ä½•è™•æœ€é©åˆå¡«å…¥ã€å¥è™Ÿã€ï¼Ÿ",
                        options: ["ç”²", "ä¹™", "ä¸™", "ä¸"],
                        answer: 3
                    },
                    {
                        name: "é›™é ­çµäºº",
                        type: "BOSS",
                        hp: 300,
                        source: "106å¹´æœƒè€ƒ Q35",
                        title: "çµäººèˆ‡è¾²å¤«",
                        content: "æœ‰äº›ç§‘å­¸å®¶æå‡ºã€Œçµäººèˆ‡è¾²å¤«ã€çš„ç†è«–ï¼Œèªç‚ºADHDè€…(æ³¨æ„åŠ›ç¼ºå¤±çš„éå‹•å…’)å…¶å¯¦æ²’æœ‰æ¯›ç—…ï¼Œåªæ˜¯ç”ŸéŒ¯äº†æ™‚ç©ºã€‚ç¾åœ¨æ‰€è¬‚æ³¨æ„åŠ›ç¼ºå¤±è€…çš„ç‰¹å¾µâ€”â€”å®¹æ˜“åˆ†å¿ƒã€è¡å‹•ã€å†’éšªæ€§å¼·ï¼Œå…¶å¯¦æ˜¯é å¤æ‰“çµæ¡é›†æ™‚ç”Ÿå­˜å¿…è¦çš„ç‰¹å¾µã€‚ç•¶äººé¡é€²åŒ–åˆ°è¾²æ¥­ç¤¾æœƒä»¥å¾Œï¼Œé€™äº›ç‰¹å¾µæ‰è®Šå¾—æ ¼æ ¼ä¸å…¥ã€‚",
                        skillTarget: ["â€”â€”", "ç‰¹å¾µ"],
                        preQuestion: "æ–‡ä¸­çš„ç ´æŠ˜è™Ÿ (â€”â€”) åŠŸèƒ½æ˜¯ä»€éº¼ï¼Ÿ",
                        preOptions: ["è²éŸ³å»¶é•·", "è§£é‡‹èªªæ˜"],
                        preAnswer: 1,
                        finalQuestion: "ä½œè€…å°ADHDè€…çš„æ ¸å¿ƒçœ‹æ³•ç‚ºä½•ï¼Ÿ",
                        options: ["æ‡‰æ¥å—è—¥ç‰©æ²»ç™‚", "ä¸å®œä»¥ç•°é¡çœ¼å…‰çœ‹å¾…", "åŸºå› æ¯”å¸¸äººå„ªç§€", "æ˜¯ç¤¾æœƒç™¼å±•çš„è² æ“”"],
                        answer: 1
                    }
                ]
            },
            {
                id: 3,
                name: "ç¬¬ä¸‰é—œï¼šé‚è¼¯è¿·å®®",
                skill: "è½‰æŠ˜ç›¾",
                icon: <Shield className="w-6 h-6 text-blue-400" />,
                desc: "å¿…å‹ç¬¬ä¸‰å¼ï¼šé‚è¼¯å­—è©ã€‚æ“‹æ‰å»¢è©±ï¼Œç•™ä¸‹é‡é»ï¼",
                bossColor: "bg-blue-800",
                enemies: [
                    {
                        name: "æ²¸æ°´æ€ª",
                        type: "å°æ€ª",
                        hp: 120,
                        source: "105å¹´æœƒè€ƒ Q31",
                        title: "æšæ¹¯æ­¢æ²¸",
                        content: "å¤«æŠ•è† ä»¥è®Šæ¿ï¼Œä¸å¦‚æ¾„å…¶æºè€Œæ¿è®Šä¹‹æ„ˆä¹Ÿï¼›æšæ¹¯ä»¥æ­¢æ²¸ï¼Œä¸å¦‚çµ•å…¶è–ªè€Œæ²¸æ­¢ä¹‹é€Ÿä¹Ÿã€‚æ˜¯ä»¥å‹å¿ƒæ–¼æœé è€…ï¼Œè«è‹¥ä¿®è¿‘è€Œå…¶é è‡ªä¾†ï¼›å¤šæ–¹ä»¥æ•‘å¤±è€…ï¼Œè«è‹¥æ”¹è¡Œè€Œå…¶å¤±è‡ªå»ã€‚",
                        skillTarget: ["æšæ¹¯ä»¥æ­¢æ²¸", "ä¸å¦‚", "çµ•å…¶è–ª"],
                        preQuestion: "ã€Œä¸å¦‚ã€å‡ºç¾æ™‚ï¼Œé‡é»åœ¨å‰é¢é‚„æ˜¯å¾Œé¢ï¼Ÿ",
                        preOptions: ["å‰é¢ (æšæ¹¯æ­¢æ²¸)", "å¾Œé¢ (çµ•è–ª)"],
                        preAnswer: 1,
                        finalQuestion: "ä¸‹åˆ—ä½•è€…æœ€ç¬¦åˆä½œè€…ã€Œæ²»æœ¬ã€çš„è§€é»ï¼Ÿ",
                        options: ["æšæ¹¯æ­¢æ²¸", "æŠ•è† è®Šæ¿", "çµ•è–ªæ­¢æ²¸", "å¤šæ–¹æ•‘å¤±"],
                        answer: 2
                    },
                    {
                        name: "æ·±å½é­”ç‹",
                        type: "BOSS",
                        hp: 400,
                        source: "113å¹´æœƒè€ƒ Q35",
                        title: "æ·±å½æŠ€è¡“",
                        content: "æ·±å½æŠ€è¡“æ˜¯è¿‘å¹´æ–°èˆˆçš„ç§‘æŠ€ï¼Œè‹¥å°‡å®ƒé‹ç”¨æ–¼å½±è¦–ä½œå“ï¼Œå¯ç¯€çœè£½ä½œé›»å½±æˆ–éŠæˆ²çš„æ™‚é–“ï¼Œæœ‰æ­£é¢çš„æ•ˆç›Šã€‚ä½†ä¹Ÿæœ‰äººåˆ©ç”¨åˆæˆçš„å‡å½±åƒæ“å¼„è³‡è¨Šï¼Œé€²è€Œè©é¨™ç‰Ÿåˆ©ã€æ¯€äººè²è­½ï¼Œè£½é€ ç¤¾æœƒçš„å‹•ç›ªï¼Œè®“é€™é …æŠ€è¡“å¼•ç™¼çˆ­è­°ã€‚",
                        skillTarget: ["æœ‰æ­£é¢çš„æ•ˆç›Š", "ä½†", "è² é¢çˆ­è­°"],
                        preQuestion: "ä½œè€…ç”¨ã€Œä½†ã€å­—è½‰æŠ˜ï¼ŒçœŸæ­£æƒ³å¼·èª¿çš„æ˜¯ï¼Ÿ",
                        preOptions: ["æ­£é¢æ•ˆç›Š", "è² é¢çˆ­è­°"],
                        preAnswer: 1,
                        finalQuestion: "æ ¹æ“šæœ¬æ–‡ï¼Œæ·±å½æŠ€è¡“æœ€å¤§çš„éš±æ†‚æ˜¯ä»€éº¼ï¼Ÿ",
                        options: ["è£½ä½œæˆæœ¬éé«˜", "å–ä»£æ¼”å“¡å·¥ä½œ", "é€ æˆæ°‘çœ¾å°ç¤¾æœƒçš„ä¸ä¿¡ä»»", "æŠ€è¡“é–€æª»å¤ªä½"],
                        answer: 2
                    }
                ]
            }
        ];

        // --- æ€ªç‰©è¦–è¦ºçµ„ä»¶ (CSS Art) ---
        const MonsterSprite = ({ type, isHit }) => {
            const hitClass = isHit ? 'monster-hit' : 'monster-idle';
            
            if (type === "å°æ€ª") {
                return (
                    <div className={`relative w-32 h-32 ${hitClass}`}>
                        <div className="absolute inset-0 bg-gradient-to-br from-green-400 to-green-600 rounded-full blur-sm opacity-70 animate-pulse"></div>
                        <div className="absolute inset-2 bg-gray-900 rounded-full flex items-center justify-center border-4 border-green-500">
                            <span className="text-5xl">ğŸ¦ </span>
                        </div>
                    </div>
                );
            } else if (type === "èè‹±") {
                return (
                    <div className={`relative w-40 h-40 ${hitClass}`}>
                        <div className="absolute inset-0 bg-gradient-to-t from-purple-600 to-transparent rounded-lg transform rotate-45 opacity-80"></div>
                        <div className="absolute inset-2 bg-gray-900 rounded-lg flex items-center justify-center border-4 border-purple-500 transform rotate-0">
                            <span className="text-6xl">ğŸ</span>
                        </div>
                    </div>
                );
            } else { // BOSS
                return (
                    <div className={`relative w-48 h-48 ${hitClass}`}>
                        <div className="absolute inset-0 bg-red-600 rounded-full blur-md opacity-50 animate-pulse"></div>
                        <div className="absolute inset-0 border-8 border-double border-red-500 rounded-full animate-spin-slow"></div>
                        <div className="absolute inset-4 bg-gray-900 rounded-full flex items-center justify-center border-2 border-red-400">
                            <span className="text-7xl drop-shadow-[0_0_10px_rgba(255,0,0,0.8)]">ğŸ‘¹</span>
                        </div>
                    </div>
                );
            }
        };

        // --- ä¸»è¦éŠæˆ²é‚è¼¯ ---
        const Game = () => {
            const [gameState, setGameState] = useState("menu"); // menu, battle, win, lose
            const [levelIdx, setLevelIdx] = useState(0);
            const [enemyIdx, setEnemyIdx] = useState(0);
            const [hp, setHp] = useState(3);
            const [enemyHp, setEnemyHp] = useState(100);
            const [phase, setPhase] = useState("observe"); // observe, skill, attack
            const [isHit, setIsHit] = useState(false);
            const [damage, setDamage] = useState(null);
            const [isShaking, setIsShaking] = useState(false);
            const [processedText, setProcessedText] = useState("");

            const currentLevel = LEVELS[levelIdx];
            const currentEnemy = currentLevel.enemies[enemyIdx];

            useEffect(() => {
                if (gameState === "battle") {
                    setEnemyHp(currentEnemy.hp);
                    setProcessedText(currentEnemy.content);
                    setPhase("observe");
                }
            }, [levelIdx, enemyIdx, gameState]);

            const triggerShake = () => {
                setIsShaking(true);
                setTimeout(() => setIsShaking(false), 500);
            };

            const showDamage = (amount) => {
                setDamage(amount);
                setIsHit(true);
                setTimeout(() => {
                    setDamage(null);
                    setIsHit(false);
                }, 1000);
            };

            const handleSkillOption = (idx) => {
                if (idx === currentEnemy.preAnswer) {
                    // æŠ€èƒ½æˆåŠŸ
                    showDamage("ç ´é˜²!");
                    
                    // è™•ç†æ–‡å­—ç‰¹æ•ˆ
                    let newText = currentEnemy.content;
                    if (currentLevel.id === 2) { // æ–·å¥
                        const parts = newText.split(currentEnemy.skillTarget);
                        newText = parts.join(`<span class="cut-mark"></span><span class="text-red-400 font-bold text-xl">${currentEnemy.skillTarget}</span>`);
                    } else if (currentLevel.id === 3) { // è½‰æŠ˜ (åˆªé™¤ç·š)
                        // ç°¡å–®æ¨¡æ“¬ï¼šæŠŠç›®æ¨™æ–‡å­—è®Šæˆç°è‰²åˆªé™¤ç·š
                        currentEnemy.skillTarget.forEach(t => {
                            newText = newText.replace(new RegExp(t, 'g'), `<span class="dim-text">${t}</span>`);
                        });
                    } else { // è¢å…‰ç­†
                        currentEnemy.skillTarget.forEach(t => {
                            newText = newText.replace(new RegExp(t, 'g'), `<span class="highlight-text">${t}</span>`);
                        });
                    }
                    setProcessedText(newText);
                    setPhase("attack");
                } else {
                    // æŠ€èƒ½å¤±æ•—
                    triggerShake();
                    setHp(prev => prev - 1);
                    if (hp <= 1) setGameState("lose");
                }
            };

            const handleAttackOption = (idx) => {
                if (idx === currentEnemy.answer) {
                    // æ”»æ“ŠæˆåŠŸ
                    showDamage("-" + currentEnemy.hp);
                    setEnemyHp(0);
                    setTimeout(() => {
                        if (enemyIdx < currentLevel.enemies.length - 1) {
                            setEnemyIdx(prev => prev + 1);
                        } else if (levelIdx < LEVELS.length - 1) {
                            setLevelIdx(prev => prev + 1);
                            setEnemyIdx(0);
                        } else {
                            setGameState("win");
                        }
                    }, 1500);
                } else {
                    // æ”»æ“Šå¤±æ•—
                    triggerShake();
                    setHp(prev => prev - 1);
                    if (hp <= 1) setGameState("lose");
                }
            };

            if (gameState === "menu") {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-gray-900 text-white p-6 space-y-8">
                        <div className="text-center">
                            <h1 className="text-5xl font-black text-yellow-500 mb-2 tracking-widest drop-shadow-lg">åœ‹æ–‡ä¹å¼</h1>
                            <h2 className="text-3xl font-bold text-red-500">é™é­”ä¿®ç…‰è·¯</h2>
                        </div>
                        <div className="grid grid-cols-2 gap-4 w-full">
                            {LEVELS.map((l, i) => (
                                <div key={i} className="bg-gray-800 p-4 rounded-lg border border-gray-600 flex flex-col items-center">
                                    <div className="mb-2">{l.icon}</div>
                                    <div className="text-sm font-bold">{l.name.split("ï¼š")[1]}</div>
                                </div>
                            ))}
                        </div>
                        <button 
                            onClick={() => setGameState("battle")}
                            className="w-full bg-red-600 hover:bg-red-500 text-white text-xl font-bold py-4 rounded-xl shadow-[0_4px_0_#991b1b] active:shadow-none active:translate-y-1 transition-all"
                        >
                            é–‹å§‹ä¿®ç…‰
                        </button>
                    </div>
                );
            }

            if (gameState === "win") {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-yellow-900 text-white p-6 text-center">
                        <div className="text-8xl mb-4">ğŸ†</div>
                        <h1 className="text-4xl font-bold mb-4">ä¿®ç…‰å®Œæˆï¼</h1>
                        <p className="text-xl mb-8">ä½ å·²æŒæ¡æœƒè€ƒè§£é¡Œå¥§ç¾©ï¼</p>
                        <button onClick={() => location.reload()} className="bg-yellow-600 px-8 py-3 rounded-full font-bold">å†ä¾†ä¸€å±€</button>
                    </div>
                );
            }

            if (gameState === "lose") {
                return (
                    <div className="h-full flex flex-col items-center justify-center bg-gray-900 text-white p-6 text-center">
                        <div className="text-8xl mb-4">ğŸ’€</div>
                        <h1 className="text-4xl font-bold mb-4 text-red-500">ä¿®ç…‰å¤±æ•—</h1>
                        <button onClick={() => location.reload()} className="bg-gray-700 px-8 py-3 rounded-full font-bold">é‡æ–°æŒ‘æˆ°</button>
                    </div>
                );
            }

            // --- BATTLE SCREEN ---
            return (
                <div className={`h-full flex flex-col relative ${isShaking ? 'screen-shake' : ''}`}>
                    {/* Header */}
                    <div className="p-3 bg-gray-800 flex justify-between items-center border-b border-gray-700 z-10">
                        <div className="flex gap-1">
                            {[...Array(3)].map((_, i) => (
                                <Heart key={i} className={`w-6 h-6 ${i < hp ? 'text-red-500 fill-current' : 'text-gray-600'}`} />
                            ))}
                        </div>
                        <div className="text-yellow-500 font-bold">{currentLevel.name}</div>
                    </div>

                    {/* Enemy Area */}
                    <div className="flex-1 flex flex-col items-center justify-center bg-gray-900 relative overflow-hidden p-4">
                        {/* Damage Text */}
                        {damage && <div className="damage-text top-1/4">{damage}</div>}
                        
                        <div className="mb-4 transform transition-all duration-300">
                            <MonsterSprite type={currentEnemy.type} isHit={isHit} />
                        </div>
                        
                        {/* HP Bar */}
                        <div className="w-48 h-4 bg-gray-700 rounded-full overflow-hidden border border-gray-600 mb-2">
                            <div 
                                className="h-full bg-red-600 transition-all duration-500 ease-out"
                                style={{ width: `${(enemyHp / currentEnemy.hp) * 100}%` }}
                            ></div>
                        </div>
                        <div className="text-gray-400 text-sm font-bold">{currentEnemy.name} ({currentEnemy.type})</div>
                    </div>

                    {/* Question / Text Area */}
                    <div className="bg-gray-800 p-4 border-t-4 border-yellow-600 flex-1 overflow-y-auto">
                        <div className="bg-black/30 p-3 rounded-lg mb-4 text-gray-300 leading-relaxed text-lg border border-gray-600">
                            <div className="text-xs text-yellow-500 mb-1 border-b border-gray-700 pb-1">
                                {currentEnemy.source} | {currentEnemy.title}
                            </div>
                            <div dangerouslySetInnerHTML={{ __html: processedText }} />
                        </div>

                        {phase === "observe" && (
                            <button 
                                onClick={() => setPhase("skill")}
                                className="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg flex items-center justify-center gap-2 animate-bounce"
                            >
                                {currentLevel.icon} ç™¼å‹•æŠ€èƒ½ï¼š{currentLevel.skill}
                            </button>
                        )}

                        {phase === "skill" && (
                            <div className="space-y-3 animate-fade-in-up">
                                <div className="text-blue-300 font-bold flex items-center gap-2">
                                    <Zap className="w-4 h-4" /> {currentEnemy.preQuestion}
                                </div>
                                {currentEnemy.preOptions.map((opt, i) => (
                                    <button 
                                        key={i}
                                        onClick={() => handleSkillOption(i)}
                                        className="w-full bg-gray-700 hover:bg-gray-600 p-3 rounded text-left border border-gray-600 text-white active:bg-blue-600 transition-colors"
                                    >
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        )}

                        {phase === "attack" && (
                            <div className="space-y-3 animate-fade-in-up">
                                <div className="text-red-300 font-bold flex items-center gap-2">
                                    <Sword className="w-4 h-4" /> {currentEnemy.finalQuestion}
                                </div>
                                {currentEnemy.options.map((opt, i) => (
                                    <button 
                                        key={i}
                                        onClick={() => handleAttackOption(i)}
                                        className="w-full bg-gray-700 hover:bg-gray-600 p-3 rounded text-left border border-gray-600 text-white active:bg-red-600 transition-colors"
                                    >
                                        <span className="text-yellow-500 mr-2">{String.fromCharCode(65+i)}.</span>
                                        {opt}
                                    </button>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<Game />);
    </script>
</body>
</html>
