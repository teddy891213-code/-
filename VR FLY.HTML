<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ†²æ³•æè¡›è€… V6ï¼šå¸åœ‹è‰¦éšŠ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', Courier, monospace; touch-action: none; }
        
        /* 3D å®¹å™¨ */
        .vr-scene { position: relative; width: 100%; height: 100%; overflow: hidden; perspective: 600px; background: radial-gradient(circle at center, #0f0518 0%, #000 100%); }
        
        /* æ˜Ÿç©ºèƒŒæ™¯ */
        .star-field {
            position: absolute; width: 100%; height: 100%;
            background-image: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px);
            background-size: 550px 550px;
            animation: stars-move 30s linear infinite;
        }
        @keyframes stars-move { from { background-position: 0 0; } to { background-position: 550px 550px; } }

        /* å±€éƒ¨æ—‹è½‰å‹•ç•« (åªè½‰é›·é”æˆ–ç’°ï¼Œä¸è½‰æ©Ÿèº«) */
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .radar-spin { transform-origin: center; animation: spin 2s linear infinite; }
        .ring-spin { transform-origin: center; animation: spin 4s linear infinite; }

        /* é–å®šåœˆåœˆ */
        .reticle-ring { transition: stroke-dashoffset 0.1s linear; transform: rotate(-90deg); transform-origin: 50% 50%; }

        /* æ‡¸æµ®å¾®å‹• (è®“é£›æ©Ÿä¸è¦æ­»æ¿) */
        @keyframes hover-float { 
            0%, 100% { transform: translateY(0); } 
            50% { transform: translateY(-5px); } 
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // é¡Œç›®è³‡æ–™åº«
        const questionBank = [
            {
                id: 1,
                text: "ç›®æ¨™ï¼šç›´è½„å¸‚ã€Œè¡Œæ”¿æ©Ÿé—œã€",
                hint: "é—œéµå­—ï¼šå¸‚æ”¿åºœ (åŸ·è¡Œ)",
                targets: [
                    { text: "æ–°åŒ—å¸‚æ”¿åºœ", type: "correct", color: "#3b82f6" },
                    { text: "å°ä¸­å¸‚æ”¿åºœ", type: "correct", color: "#3b82f6" },
                    { text: "é«˜é›„å¸‚æ”¿åºœ", type: "correct", color: "#3b82f6" },
                    { text: "å°åŒ—å¸‚æ”¿åºœ", type: "correct", color: "#3b82f6" },
                    { text: "æ–°åŒ—å¸‚è­°æœƒ", type: "wrong", color: "#ef4444" },
                    { text: "æ¿æ©‹å€å…¬æ‰€", type: "wrong", color: "#9ca3af" },
                    { text: "å°ä¸­å¸‚è­°æœƒ", type: "wrong", color: "#ef4444" }
                ]
            },
            {
                id: 2,
                text: "ç›®æ¨™ï¼šç¸£å¸‚ã€Œç«‹æ³•æ©Ÿé—œã€",
                hint: "é—œéµå­—ï¼šè­°æœƒ (ç›£ç£)",
                targets: [
                    { text: "èŠ±è“®ç¸£è­°æœƒ", type: "correct", color: "#a855f7" },
                    { text: "å˜‰ç¾©ç¸£è­°æœƒ", type: "correct", color: "#a855f7" },
                    { text: "æ–°ç«¹å¸‚è­°æœƒ", type: "correct", color: "#a855f7" },
                    { text: "å®œè˜­ç¸£è­°æœƒ", type: "correct", color: "#a855f7" },
                    { text: "èŠ±è“®ç¸£æ”¿åºœ", type: "wrong", color: "#ef4444" },
                    { text: "å°æ±ç¸£æ”¿åºœ", type: "wrong", color: "#ef4444" },
                    { text: "å®œè˜­å¸‚å…¬æ‰€", type: "wrong", color: "#9ca3af" }
                ]
            },
            {
                id: 3,
                text: "ç›®æ¨™ï¼šå±±åœ°åŸä½æ°‘å€",
                hint: "é—œéµï¼šå€å…¬æ‰€ / è‡ªæ²»",
                targets: [
                    { text: "çƒä¾†å€å…¬æ‰€", type: "correct", color: "#22c55e" },
                    { text: "å’Œå¹³å€å…¬æ‰€", type: "correct", color: "#22c55e" },
                    { text: "èŒ‚æ—å€å…¬æ‰€", type: "correct", color: "#22c55e" },
                    { text: "é‚£ç‘ªå¤å€å…¬æ‰€", type: "correct", color: "#22c55e" },
                    { text: "å¤§å®‰å€å…¬æ‰€", type: "wrong", color: "#9ca3af" },
                    { text: "ä¸­å’Œå€å…¬æ‰€", type: "wrong", color: "#9ca3af" },
                    { text: "ä¿¡ç¾©å€å…¬æ‰€", type: "wrong", color: "#9ca3af" }
                ]
            }
        ];

        // ğŸš€ å¤šæ¨£åŒ–çš„ UFO å…ƒä»¶
        const UFO = ({ color, text, variant }) => {
            // æ ¹æ“š variant (0, 1, 2) é¡¯ç¤ºä¸åŒé£›èˆ¹
            const renderShip = () => {
                if (variant === 0) {
                    // ç¶“å…¸åœ“ç›¤å‹ (Classic Saucer)
                    return (
                        <svg viewBox="0 0 100 60" className="w-24 h-16 drop-shadow-[0_0_15px_rgba(255,255,255,0.6)]">
                            <ellipse cx="50" cy="30" rx="48" ry="14" fill={color} stroke="white" strokeWidth="2" />
                            <circle cx="50" cy="22" r="16" fill="rgba(255,255,255,0.9)" />
                            {/* æ—‹è½‰çš„ç‡ˆå…‰ç’° */}
                            <g className="radar-spin" style={{transformOrigin: '50% 30px'}}>
                                <circle cx="50" cy="30" r="3" fill="#ff0" transform="translate(30, 0)" />
                                <circle cx="50" cy="30" r="3" fill="#ff0" transform="translate(-30, 0)" />
                            </g>
                        </svg>
                    );
                } else if (variant === 1) {
                    // æˆ°æ©Ÿå‹ (Fighter)
                    return (
                        <svg viewBox="0 0 100 80" className="w-24 h-20 drop-shadow-[0_0_15px_rgba(255,255,255,0.6)]">
                            <path d="M50 0 L80 60 L50 50 L20 60 Z" fill={color} stroke="white" strokeWidth="2" />
                            <rect x="45" y="60" width="10" height="15" fill="orange" className="animate-pulse" />
                            <circle cx="50" cy="30" r="5" fill="#0ff" className="animate-ping" />
                        </svg>
                    );
                } else {
                    // ç„¡äººæ©Ÿå‹ (Drone Orb)
                    return (
                        <svg viewBox="0 0 100 100" className="w-24 h-24 drop-shadow-[0_0_15px_rgba(255,255,255,0.6)]">
                            <circle cx="50" cy="50" r="20" fill={color} stroke="white" strokeWidth="2" />
                            {/* æ—‹è½‰çš„å¤–ç’° */}
                            <g className="ring-spin" style={{transformOrigin: '50px 50px'}}>
                                <path d="M50 10 A40 40 0 0 1 90 50" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" />
                                <path d="M50 90 A40 40 0 0 1 10 50" fill="none" stroke="white" strokeWidth="3" strokeLinecap="round" />
                            </g>
                            <circle cx="50" cy="50" r="8" fill="red" className="animate-pulse" />
                        </svg>
                    );
                }
            };

            return (
                <div className="flex flex-col items-center" style={{animation: 'hover-float 2s ease-in-out infinite'}}>
                    {renderShip()}
                    <div className="mt-2 bg-black/80 border border-white/50 text-white px-3 py-1 rounded text-xl font-bold whitespace-nowrap backdrop-blur-sm shadow-lg">
                        {text}
                    </div>
                </div>
            );
        };

        const EyeView = ({ isLeft, gameState, score, health, currentQ, enemies, focusingId, focusProgress }) => {
            return (
                <div className={`vr-scene border-r-2 border-gray-900 ${isLeft ? '' : 'border-l-0'}`}>
                    <div className="star-field"></div>
                    
                    <div className={`absolute inset-0 pointer-events-none z-50 transition-colors duration-200 ${health < 30 ? 'bg-red-900/30 animate-pulse' : ''}`}></div>

                    {/* HUD */}
                    <div className="absolute top-10 left-0 w-full flex justify-center z-20 pointer-events-none">
                        <div className="bg-slate-900/90 border-2 border-blue-500 px-8 py-4 rounded-xl text-center backdrop-blur-md shadow-[0_0_25px_#3b82f6]">
                            <div className="text-yellow-400 text-3xl font-bold tracking-widest mb-2">{currentQ.text}</div>
                            <div className="text-blue-100 text-xl">{currentQ.hint}</div>
                        </div>
                    </div>

                    <div className="absolute bottom-12 w-full flex justify-between px-20 z-20 text-2xl font-bold font-mono">
                        <div className="text-green-400 drop-shadow-md">SCORE: {score}</div>
                        <div className={health < 40 ? "text-red-500 drop-shadow-md" : "text-blue-400 drop-shadow-md"}>SHIELD: {health}%</div>
                    </div>

                    {/* æº–å¿ƒ */}
                    <div className="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-50 pointer-events-none">
                        <svg width="80" height="80" viewBox="0 0 80 80">
                            <circle cx="40" cy="40" r="4" fill="#0f0" />
                            <circle cx="40" cy="40" r="30" fill="none" stroke="#0f0" strokeWidth="4"
                                strokeDasharray="188" strokeDashoffset={188 - (188 * focusProgress / 100)}
                                className="reticle-ring" opacity={focusProgress > 0 ? 1 : 0.3} />
                        </svg>
                    </div>

                    {/* æ•µäººæ¸²æŸ“ */}
                    {gameState === 'playing' && enemies.map(enemy => (
                        <div
                            key={enemy.id}
                            className="absolute top-1/2 left-1/2 flex flex-col items-center justify-center transform transition-transform duration-75 will-change-transform"
                            style={{
                                transform: `translate(-50%, -50%) translate3d(${enemy.x}vw, ${enemy.y}vh, 0) scale(${enemy.scale})`,
                                zIndex: Math.floor(enemy.scale * 100),
                                opacity: enemy.scale < 0.05 ? 0 : 1,
                                filter: focusingId === enemy.id ? 'drop-shadow(0 0 15px #facc15)' : 'none'
                            }}
                        >
                            <UFO color={enemy.color} text={enemy.text} variant={enemy.variant} />
                        </div>
                    ))}
                </div>
            );
        };

        const App = () => {
            const [gameState, setGameState] = useState('start'); 
            const [mode, setMode] = useState('single'); 
            const [score, setScore] = useState(0);
            const [health, setHealth] = useState(100);
            const [level, setLevel] = useState(0);
            const [enemies, setEnemies] = useState([]);
            
            const [focusingId, setFocusingId] = useState(null);
            const [focusProgress, setFocusProgress] = useState(0);

            const frameRef = useRef();
            const spawnTimerRef = useRef();
            const lastTimeRef = useRef(0);
            const focusTimerRef = useRef(0);

            const currentQ = questionBank[level];

            const spawnEnemy = () => {
                const isCorrect = Math.random() > 0.45; // ç¨å¾®å¹³è¡¡æ­£ç¢ºæ©Ÿç‡
                const targetPool = isCorrect 
                    ? currentQ.targets.filter(t => t.type === 'correct') 
                    : currentQ.targets.filter(t => t.type === 'wrong');
                const template = targetPool[Math.floor(Math.random() * targetPool.length)];
                
                // æ“´å¤§éš¨æ©Ÿå‡ºç¾ç¯„åœ
                const startX = (Math.random() - 0.5) * 110;
                const startY = (Math.random() - 0.5) * 85;

                setEnemies(prev => [...prev, {
                    id: Date.now() + Math.random(),
                    ...template,
                    x: startX,
                    y: startY,
                    variant: Math.floor(Math.random() * 3), // éš¨æ©Ÿ 0~2 é€ å‹
                    scale: 0.02, 
                    // ğŸš€ é—œéµä¿®æ”¹ï¼šé€Ÿåº¦è®Šæ…¢ (æ”»æ“Šæ™‚é–“æ‹‰é•·åˆ° 4ç§’ä»¥ä¸Š)
                    // åŸæœ¬ 0.0025 -> æ”¹ç‚º 0.00045
                    speed: 0.00045 + (level * 0.00005) 
                }]);
            };

            const gameLoop = (time) => {
                if (gameState !== 'playing') return;
                const deltaTime = time - lastTimeRef.current;
                lastTimeRef.current = time;

                let hitId = null;

                setEnemies(prev => {
                    const nextEnemies = [];
                    let closestId = null;
                    let minDistance = 25; // é–å®šåˆ¤å®šç¯„åœ

                    prev.forEach(enemy => {
                        // 1. ç§»å‹•
                        enemy.scale += enemy.speed * (deltaTime || 16);

                        // 2. è·é›¢åˆ¤å®š (ç”¨æ–¼å‡è¦–)
                        const dist = Math.sqrt(enemy.x * enemy.x + enemy.y * enemy.y);
                        
                        // é–å®šæ¢ä»¶ï¼šä¸èƒ½å¤ªé (å¤ªå°)ï¼Œä¸”è¦åœ¨æº–å¿ƒç¯„åœå…§
                        if (enemy.scale > 0.25 && dist < minDistance) {
                            closestId = enemy.id;
                            minDistance = dist;
                        }

                        // 3. æ’æ“Šåˆ¤å®š (scale > 2.0 ä»£è¡¨éå¸¸è¿‘äº†)
                        if (enemy.scale > 2.0) {
                            if (enemy.type === 'correct') {
                                setHealth(h => Math.max(0, h - 15)); // æ¼æ¥
                            }
                        } else {
                            nextEnemies.push(enemy);
                        }
                    });

                    // 4. å‡è¦–é–å®šé‚è¼¯
                    if (closestId) {
                        if (closestId !== focusingId) {
                            setFocusingId(closestId);
                            setFocusProgress(0);
                            focusTimerRef.current = 0;
                        } else {
                            focusTimerRef.current += deltaTime;
                            // é–å®šæ™‚é–“ï¼š1.2ç§’ (ç¨å¾®ç¸®çŸ­ä¸€é»é»ï¼Œå¢åŠ æ‰‹æ„Ÿ)
                            const progress = Math.min(100, (focusTimerRef.current / 1200) * 100);
                            setFocusProgress(progress);
                            if (focusTimerRef.current >= 1200) {
                                hitId = closestId; 
                                setFocusingId(null);
                                setFocusProgress(0);
                                focusTimerRef.current = 0;
                            }
                        }
                    } else {
                        setFocusingId(null);
                        setFocusProgress(0);
                    }

                    if (hitId) {
                        const hitEnemy = prev.find(e => e.id === hitId);
                        if (hitEnemy) handleHit(hitEnemy);
                        return nextEnemies.filter(e => e.id !== hitId);
                    }

                    return nextEnemies;
                });

                if (health <= 0) setGameState('gameover');
                else frameRef.current = requestAnimationFrame(gameLoop);
            };

            const handleHit = (enemy) => {
                if (enemy.type === 'correct') {
                    setScore(s => s + 100);
                    if ((score + 100) % 500 === 0 && level < questionBank.length - 1) {
                        setLevel(l => l + 1);
                        setEnemies([]);
                    } else if ((score + 100) >= questionBank.length * 500) {
                        setGameState('win');
                    }
                } else {
                    setHealth(h => Math.max(0, h - 20));
                    if (navigator.vibrate) navigator.vibrate(300);
                }
            };

            useEffect(() => {
                if (gameState === 'playing') {
                    lastTimeRef.current = performance.now();
                    frameRef.current = requestAnimationFrame(gameLoop);
                    // ğŸš€ é—œéµä¿®æ”¹ï¼šé »ç‡è®Šé«˜ (0.8ç§’ä¸€éš»)
                    spawnTimerRef.current = setInterval(spawnEnemy, 800); 
                }
                return () => {
                    cancelAnimationFrame(frameRef.current);
                    clearInterval(spawnTimerRef.current);
                };
            }, [gameState, level, health, focusingId, score]);

            if (gameState === 'start' || gameState === 'gameover' || gameState === 'win') {
                return (
                    <div className="flex flex-col items-center justify-center h-screen bg-black text-white font-mono p-4 text-center bg-[url('https://images.unsplash.com/photo-1534796636912-3b95b3ab5986?ixlib=rb-4.0.3&auto=format&fit=crop&w=2342&q=80')] bg-cover bg-center">
                        <div className="bg-black/80 p-8 rounded-2xl backdrop-blur-sm border border-blue-500/30">
                            <h1 className="text-4xl md:text-6xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-purple-500">
                                {gameState === 'start' ? 'æ†²æ³•æè¡›è€… V6' : (gameState === 'win' ? 'ä»»å‹™å®Œæˆï¼' : 'è­·ç›¾ææ¯€')}
                            </h1>
                            <p className="mb-8 text-gray-300">å¸åœ‹è‰¦éšŠä¾†è¥²ï¼è«‹é–å®šä¸¦æ“Šè½æ­£ç¢ºç›®æ¨™ã€‚</p>
                            
                            {gameState !== 'start' && <div className="text-4xl mb-8 text-yellow-400 font-bold">SCORE: {score}</div>}

                            <div className="space-y-4 w-full max-w-md mx-auto">
                                <button onClick={() => { setMode('single'); setGameState('playing'); setHealth(100); setScore(0); setLevel(0); }}
                                    className="w-full py-4 bg-gray-800 border-2 border-blue-500 rounded-xl hover:bg-gray-700 text-xl font-bold transition flex items-center justify-center gap-2">
                                    ğŸ“± å–®è¢å¹•æ¨¡å¼
                                </button>
                                <button onClick={() => { setMode('vr'); setGameState('playing'); setHealth(100); setScore(0); setLevel(0); }}
                                    className="w-full py-4 bg-blue-600 rounded-xl hover:bg-blue-700 text-xl font-bold shadow-[0_0_20px_#2563eb] transition flex items-center justify-center gap-2">
                                    ğŸ‘“ VR çœ¼é¡æ¨¡å¼
                                </button>
                            </div>
                            <p className="mt-8 text-xs text-gray-400">
                                èªªæ˜ï¼šæ•µæ©Ÿå¾é è™•é£›ä¾†ç´„éœ€ 4 ç§’ã€‚<br/>
                                è«‹å¿«é€Ÿæƒæï¼Œé–å®šæ­£ç¢ºç›®æ¨™ 1.2 ç§’å³å¯æ“Šè½ã€‚
                            </p>
                        </div>
                    </div>
                );
            }

            return (
                <div className="w-full h-screen bg-black flex overflow-hidden">
                    {mode === 'vr' ? (
                        <>
                            <div className="w-1/2 h-full relative overflow-hidden">
                                <EyeView isLeft={true} {...{gameState, score, health, currentQ, enemies, focusingId, focusProgress}} />
                            </div>
                            <div className="w-1/2 h-full relative overflow-hidden">
                                <EyeView isLeft={false} {...{gameState, score, health, currentQ, enemies, focusingId, focusProgress}} />
                            </div>
                            <div className="absolute top-1/2 left-1/2 w-[1px] h-10 bg-white/30 transform -translate-x-1/2 -translate-y-1/2"></div>
                        </>
                    ) : (
                        <div className="w-full h-full relative overflow-hidden">
                            <EyeView isLeft={true} {...{gameState, score, health, currentQ, enemies, focusingId, focusProgress}} />
                            {/* æ‰‹æŒæ¨¡å¼é»æ“ŠåŠŸèƒ½ */}
                            {enemies.map(enemy => (
                                <div key={`touch-${enemy.id}`} 
                                    className="absolute top-1/2 left-1/2 w-32 h-32 transform -translate-x-1/2 -translate-y-1/2 cursor-pointer"
                                    style={{ transform: `translate(-50%, -50%) translate3d(${enemy.x}vw, ${enemy.y}vh, 0) scale(${enemy.scale})`, zIndex: 200 }}
                                    onClick={() => {
                                        if(enemy.type === 'correct') handleHit(enemy);
                                        else setHealth(h => Math.max(0, h-20));
                                    }}
                                ></div>
                            ))}
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
