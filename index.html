<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>豆子行政官 - 零延遲靈敏版</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { user-select: none; -webkit-user-select: none; touch-action: none; background-color: #0f172a; overflow: hidden; margin: 0; padding: 0; font-family: system-ui, -apple-system, sans-serif; }
        * { -webkit-tap-highlight-color: transparent; }
        .glow-text { text-shadow: 0 0 4px rgba(0,0,0,0.5); }
        .label-text { white-space: nowrap; }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 圖示 ---
        const Heart = () => <svg width="24" height="24" fill="currentColor" className="text-red-500"><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>;
        const Zap = () => <svg width="24" height="24" fill="currentColor" className="text-yellow-400"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>;
        const Skull = ({color}) => <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="M12.5 17l-.5-4"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/><path d="M12 13v4"/></svg>;

        const MAP_LAYOUT = [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,1,1,1,0,1,1,1,2,1,2,1,1,1,0,1,1,1,1],[2,2,2,1,0,1,2,2,2,9,2,2,2,1,0,1,2,2,2],[1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,0,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]];
        const QUESTIONS = [
            { id: 1, text: '「購買 F-16 戰機」是誰的權限？', correct: '中央政府', options: ['中央政府', '地方政府', '村里長', '各級學校'] },
            { id: 2, text: '「決定放颱風假」是誰的權限？', correct: '地方政府', options: ['中央政府', '地方政府', '氣象署', '總統'] },
            { id: 3, text: '「發行新台幣」是誰的權限？', correct: '中央政府', options: ['中央政府', '地方政府', '一般銀行', '便利商店'] },
            { id: 4, text: '「規劃公車路線」是誰的責任？', correct: '地方政府', options: ['地方政府', '中央政府', '公車司機', '警察局'] },
            { id: 5, text: '「舉辦流感疫苗施打」屬於哪類？', correct: '安全衛生', options: ['安全衛生', '經濟發展', '教育文化', '社會服務'] },
            { id: 6, text: '「發放愛心餐券」屬於哪類？', correct: '社會服務', options: ['社會服務', '國防外交', '經濟發展', '教育文化'] }
        ];

        function App() {
            const [status, setStatus] = useState('MENU');
            const [player, setPlayer] = useState({ x: 9, y: 12 });
            const [ghosts, setGhosts] = useState([]);
            const [answers, setAnswers] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [health, setHealth] = useState(3);
            const [dots, setDots] = useState([]);
            const [invincible, setInvincible] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [mouthOpen, setMouthOpen] = useState(true);
            
            const heldDirections = useRef(new Set());
            const currentDir = useRef('RIGHT');
            const lastMoveTime = useRef(0); // 用於冷卻時間

            const initGame = () => {
                setScore(0); setHealth(3); setQIndex(0); setPlayer({ x: 9, y: 12 }); setInvincible(0);
                const d = []; MAP_LAYOUT.forEach((row, y) => row.forEach((cell, x) => { if (cell === 0) d.push({ x, y }); }));
                setDots(d); spawnQuestion(0); setStatus('PLAYING');
            };

            const spawnQuestion = (index) => {
                if (index >= QUESTIONS.length) { setStatus('WIN'); return; }
                const q = QUESTIONS[index];
                const pos = [
                    {x:1, y:1, alignX:'left', alignY:'top'},
                    {x:17, y:1, alignX:'right', alignY:'top'},
                    {x:1, y:16, alignX:'left', alignY:'bottom'},
                    {x:17, y:16, alignX:'right', alignY:'bottom'}
                ];
                setAnswers(pos.map((p, i) => ({ ...p, text: q.options[i], isCorrect: q.options[i] === q.correct, t: Date.now()+1000 })));
                
                const ghostCount = 1 + index; 
                const newGhosts = [];
                for(let i=0; i<ghostCount; i++) {
                    newGhosts.push({
                        id: Date.now() + i,
                        x: 9, y: 8,
                        color: i % 2 === 0 ? '#ef4444' : '#3b82f6'
                    });
                }
                setGhosts(newGhosts);
            };

            // --- 核心移動邏輯 (抽出成獨立函數) ---
            const attemptMove = (dir) => {
                const now = Date.now();
                // 限制移動頻率：如果距離上次移動小於 100ms，則忽略（防爆衝）
                if (now - lastMoveTime.current < 100) return;
                
                lastMoveTime.current = now;
                currentDir.current = dir;

                setPlayer(p => {
                    let n = {...p};
                    if (dir==='UP') n.y--; if (dir==='DOWN') n.y++; if (dir==='LEFT') n.x--; if (dir==='RIGHT') n.x++;
                    if (n.y>=0 && n.y<MAP_LAYOUT.length && n.x>=0 && n.x<MAP_LAYOUT[0].length && MAP_LAYOUT[n.y][n.x]!==1) {
                        
                        // 吃豆 +10分
                        setDots(prev => {
                            const remaining = prev.filter(d => !(d.x === n.x && d.y === n.y));
                            if (remaining.length < prev.length) setScore(s => s + 10);
                            return remaining;
                        });

                        // 撞答案
                        const hit = answers.find(a => a.x === n.x && a.y === n.y && Date.now() > a.t);
                        if (hit) {
                            if (hit.isCorrect) {
                                setScore(s => s + 500); setInvincible(40); setFeedback({msg:"答對了！反擊時刻！", type:"ok"});
                                setAnswers([]); setTimeout(() => { spawnQuestion(qIndex + 1); setQIndex(i => i + 1); setFeedback(null); }, 1500);
                            } else {
                                setHealth(h => h - 1); setFeedback({msg:"答錯了！", type:"err"});
                                setTimeout(() => setFeedback(null), 1000);
                                if (health <= 1) setStatus('GAMEOVER');
                            }
                        }
                        return n;
                    }
                    return p;
                });
            };

            // --- 點擊按鈕處理 (立即觸發) ---
            const handleBtnDown = (dir) => {
                heldDirections.current.add(dir);
                attemptMove(dir); // ★ 關鍵：一按下去立刻嘗試移動，不用等 Loop
            };

            const handleBtnUp = (dir) => {
                heldDirections.current.delete(dir);
            };

            useEffect(() => {
                if (status !== 'PLAYING') return;
                const loop = setInterval(() => {
                    setMouthOpen(m => !m);
                    if (invincible > 0) setInvincible(t => t - 1);

                    // --- 連續移動檢查 ---
                    if (heldDirections.current.size > 0) {
                        const dir = Array.from(heldDirections.current).pop();
                        attemptMove(dir); // 長按時由這裡觸發
                    }

                    // --- 鬼的 AI ---
                    setGhosts(prev => prev.map(g => {
                        if (Math.random() > 0.4) { 
                            const dx = player.x - g.x; const dy = player.y - g.y;
                            let targetX = dx > 0 ? 1 : -1; let targetY = dy > 0 ? 1 : -1;

                            if (invincible > 0) { targetX *= -1; targetY *= -1; } // 躲避

                            let nx = g.x, ny = g.y;
                            if (Math.abs(dx) > Math.abs(dy)) nx += targetX; else ny += targetY;
                            
                            // 防卡牆
                            if (MAP_LAYOUT[ny][nx] === 1) {
                                const moves = [{x:0,y:1},{x:0,y:-1},{x:1,y:0},{x:-1,y:0}].filter(m => {
                                    const mx = g.x+m.x, my = g.y+m.y;
                                    return mx>=0 && mx<19 && my>=0 && my<18 && MAP_LAYOUT[my][mx]!==1;
                                });
                                if(moves.length > 0) {
                                    const m = moves[Math.floor(Math.random()*moves.length)];
                                    nx = g.x + m.x; ny = g.y + m.y;
                                } else { nx = g.x; ny = g.y; }
                            }
                            if (nx>=0 && nx<19 && ny>=0 && ny<18 && MAP_LAYOUT[ny][nx]!==1) return {...g, x: nx, y: ny};
                        }
                        return g;
                    }));

                    // --- 碰撞檢測 ---
                    setGhosts(gs => {
                        const hit = gs.find(g => g.x === player.x && g.y === player.y);
                        if (hit) {
                            if (invincible > 0) {
                                setScore(s => s + 200);
                                setFeedback({msg:"吃掉鬼魂！+200分", type:"ok"});
                                setTimeout(() => setFeedback(null), 800);
                                return gs.filter(g => g.id !== hit.id);
                            } else {
                                setHealth(h => {
                                    const newH = h - 1;
                                    if (newH <= 0) setStatus('GAMEOVER');
                                    return newH;
                                });
                                setInvincible(15); setFeedback({msg:"被抓到了！", type:"err"}); 
                                setTimeout(()=>setFeedback(null), 1000);
                            }
                        }
                        return gs;
                    });

                }, 200); 
                return () => clearInterval(loop);
            }, [status, player, answers, invincible, health, qIndex]);

            // ... (樣式函數同前) ...
            const getLabelStyle = (alignX, alignY) => {
                let cls = "absolute bg-white text-black text-sm md:text-base font-black px-3 py-1.5 rounded-lg shadow-xl label-text border-2 border-blue-600 z-50 ";
                if (alignY === 'top') cls += "-top-10 "; else cls += "-bottom-10 "; 
                if (alignX === 'left') cls += "left-0 origin-bottom-left "; else cls += "right-0 origin-bottom-right ";
                return cls;
            };

            return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-950 p-2 overflow-hidden">
                    {status === 'MENU' ? (
                        <div className="text-center">
                             <h1 className="text-4xl text-white font-black mb-8 tracking-widest">豆子行政官</h1>
                             <button onClick={initGame} className="bg-yellow-500 px-12 py-6 rounded-3xl text-3xl font-black shadow-[0_0_30px_yellow] border-b-8 border-yellow-700 active:translate-y-2 active:border-b-0 transition-all">挑戰開始</button>
                        </div>
                    ) : (
                        <>
                            <div className="w-full max-w-lg flex justify-between px-4 mb-2 text-2xl font-bold">
                                <div className="text-red-500 flex items-center gap-2 bg-slate-900 px-4 py-1 rounded-full border border-slate-700"><Heart/> {health}</div>
                                <div className="text-yellow-400 flex items-center gap-2 bg-slate-900 px-4 py-1 rounded-full border border-slate-700"><Zap/> {score}</div>
                            </div>
                            
                            <div className="w-full max-w-lg bg-slate-800 p-4 rounded-2xl border-4 border-slate-600 text-center relative mb-4 shadow-xl min-h-[5rem] flex items-center justify-center">
                                <h3 className="text-2xl text-white font-bold leading-relaxed">{QUESTIONS[qIndex]?.text}</h3>
                                {feedback && (
                                    <div className={`absolute inset-0 flex items-center justify-center rounded-xl text-white font-black text-2xl z-50 animate-bounce ${feedback.type==='ok'?'bg-green-600/95':'bg-red-600/95'}`}>
                                        {feedback.msg}
                                    </div>
                                )}
                            </div>

                            <div className="relative bg-black p-4 rounded-xl border-4 border-slate-700 shadow-2xl overflow-visible">
                                {MAP_LAYOUT.map((row, y) => (
                                    <div key={y} className="flex">
                                        {row.map((cell, x) => (
                                            <div key={x} className={`w-5 h-5 md:w-6 md:h-6 flex items-center justify-center relative ${cell===1?'bg-slate-800 border-[0.5px] border-slate-900':'bg-black'}`}>
                                                {dots.some(d=>d.x===x && d.y===y) && <div className="w-1.5 h-1.5 bg-slate-600 rounded-full" />}
                                                
                                                {/* 玩家 */}
                                                {player.x===x && player.y===y && (
                                                    <div className={`w-4 h-4 md:w-5 md:h-5 ${invincible>0?'text-white drop-shadow-[0_0_10px_white]':'text-yellow-400 drop-shadow-[0_0_5px_yellow]'} transition-transform duration-100 z-20 ${{UP:'-rotate-90',DOWN:'rotate-90',LEFT:'rotate-180',RIGHT:'rotate-0'}[currentDir.current]}`}>
                                                        <svg viewBox="0 0 100 100" fill="currentColor">{mouthOpen?<path d="M100,50 L50,50 L85,15 A50,50 0 1,0 85,85 Z"/>:<circle cx="50" cy="50" r="50"/>}</svg>
                                                    </div>
                                                )}
                                                {/* 鬼魂 */}
                                                {ghosts.some(g=>g.x===x && g.y===y) && (
                                                    <div className="z-10 animate-pulse"><Skull color={invincible>0?'#fff':ghosts.find(g=>g.x===x&&g.y===y).color}/></div>
                                                )}
                                                {/* 標籤 */}
                                                {answers.find(a=>a.x===x && a.y===y) && (
                                                    <div className="absolute inset-0 flex items-center justify-center z-50">
                                                        <div className="w-4 h-4 md:w-5 md:h-5 bg-blue-500 rounded-full border-2 border-white animate-ping opacity-50 absolute" />
                                                        <div className="w-3 h-3 md:w-4 md:h-4 bg-blue-400 rounded-full border border-white relative" />
                                                        <div className={getLabelStyle(answers.find(a=>a.x===x&&a.y===y).alignX, answers.find(a=>a.x===x&&a.y===y).alignY)}>
                                                            {answers.find(a=>a.x===x&&a.y===y).text}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        ))}
                                    </div>
                                ))}
                            </div>

                            <div className="mt-6 grid grid-cols-3 gap-3 bg-slate-800 p-4 rounded-3xl shadow-xl border border-slate-600">
                                <div/><Btn d="UP" onD={()=>handleBtnDown('UP')} onU={()=>handleBtnUp('UP')} icon="▲"/><div/>
                                <Btn d="LEFT" onD={()=>handleBtnDown('LEFT')} onU={()=>handleBtnUp('LEFT')} icon="◀"/>
                                <Btn d="DOWN" onD={()=>handleBtnDown('DOWN')} onU={()=>handleBtnUp('DOWN')} icon="▼"/>
                                <Btn d="RIGHT" onD={()=>handleBtnDown('RIGHT')} onU={()=>handleBtnUp('RIGHT')} icon="▶"/>
                            </div>
                        </>
                    )}
                    {(status === 'WIN' || status === 'GAMEOVER') && (
                        <div className="absolute inset-0 bg-slate-900/95 flex flex-col items-center justify-center z-[100] text-white animate-fade-in">
                            <h1 className="text-6xl font-black mb-6 drop-shadow-lg">{status==='WIN'?'任務完成！':'挑戰失敗'}</h1>
                            <p className="text-2xl mb-8">最終得分：<span className="text-yellow-400 font-mono">{score}</span></p>
                            <button onClick={()=>setStatus('MENU')} className="bg-slate-700 hover:bg-slate-600 px-8 py-4 rounded-xl text-xl font-bold border-2 border-slate-500 transition-colors">回主選單</button>
                        </div>
                    )}
                </div>
            );
        }

        const Btn = ({ icon, onD, onU }) => (
            <button className="w-16 h-16 md:w-20 md:h-20 bg-slate-700 text-white text-3xl md:text-4xl rounded-2xl flex items-center justify-center active:bg-yellow-500 active:text-black active:scale-90 transition-all touch-none shadow-lg border-b-4 border-slate-900 select-none"
                    onPointerDown={(e)=>{e.preventDefault(); onD();}} onPointerUp={(e)=>{e.preventDefault(); onU();}} onPointerLeave={(e)=>{e.preventDefault(); onU();}}>{icon}</button>
        );

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
