<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>豆子行政官 - 完全版</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            background-color: #0f172a;
            overflow: hidden;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
            height: 100vh;
        }
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- 1. 補回所有精美圖示 ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Heart = (props) => <IconBase {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Ghost = (props) => <IconBase {...props}><path d="M9 22v-2a3 3 0 0 1 3-3h0a3 3 0 0 1 3 3v2"/><path d="M9 2v2"/><path d="M15 2v2"/><path d="M12 2v2"/><path d="M5 22v-6a7 7 0 0 1 14 0v6"/><path d="M9 13h.01"/><path d="M15 13h.01"/></IconBase>;
        const Skull = (props) => <IconBase {...props}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="M12.5 17l-.5-4"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/><path d="M12 13v4"/></IconBase>;
        const ChevronUp = (props) => <IconBase {...props}><polyline points="18 15 12 9 6 15"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><polyline points="6 9 12 15 18 9"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><polyline points="15 18 9 12 15 6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6"/></IconBase>;

        // --- 2. 補回完整題目與地圖 ---
        const MAP_LAYOUT = [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,1,1,1,0,1,1,1,2,1,2,1,1,1,0,1,1,1,1],[2,2,2,1,0,1,2,2,2,9,2,2,2,1,0,1,2,2,2],[1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,0,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]];
        const QUESTIONS = [
            { id: 1, text: '「購買 F-16 戰機」是誰的權限？', correctCategory: 'central', options: [{ text: '中央政府', category: 'central' }, { text: '地方政府', category: 'local' }, { text: '村里長', category: 'local_sub' }, { text: '各級學校', category: 'edu' }] },
            { id: 2, text: '「決定放颱風假」是誰的權限？', correctCategory: 'local', options: [{ text: '中央政府', category: 'central' }, { text: '地方政府', category: 'local' }, { text: '氣象署', category: 'central_sub' }, { text: '總統', category: 'president' }] },
            { id: 3, text: '「發行新台幣」是誰的權限？', correctCategory: 'central', options: [{ text: '中央政府', category: 'central' }, { text: '地方政府', category: 'local' }, { text: '一般銀行', category: 'bank' }, { text: '便利商店', category: 'store' }] },
            { id: 4, text: '「規劃公車路線」是誰的責任？', correctCategory: 'local', options: [{ text: '地方政府', category: 'local' }, { text: '中央政府', category: 'central' }, { text: '公車司機', category: 'driver' }, { text: '警察局', category: 'police' }] }
        ];

        // --- 3. 核心邏輯 ---
        function App() {
            const [status, setStatus] = useState('MENU');
            const [player, setPlayer] = useState({ x: 9, y: 12 });
            const [ghosts, setGhosts] = useState([]);
            const [answers, setAnswers] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [health, setHealth] = useState(3);
            const [dots, setDots] = useState([]);
            const [invincibleTimer, setInvincibleTimer] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [mouthOpen, setMouthOpen] = useState(true);
            const heldDirections = useRef(new Set());
            const currentDir = useRef('RIGHT');

            const initGame = () => {
                setScore(0); setHealth(3); setQIndex(0); setPlayer({ x: 9, y: 12 }); setInvincibleTimer(0);
                const d = []; MAP_LAYOUT.forEach((row, y) => row.forEach((cell, x) => { if (cell === 0) d.push({ x, y }); }));
                setDots(d); spawnQuestion(0); setStatus('PLAYING');
            };

            const spawnQuestion = (index) => {
                if (index >= QUESTIONS.length) { setStatus('WIN'); return; }
                const q = QUESTIONS[index];
                setAnswers([{x:1,y:1},{x:17,y:1},{x:1,y:16},{x:17,y:16}].map((pos, i) => ({
                    ...pos, text: q.options[i].text, isCorrect: q.options[i].category === q.correctCategory, activeTime: Date.now() + 1000
                })));
                setGhosts([{id:1,x:9,y:8,color:'#ef4444'},{id:2,x:9,y:8,color:'#3b82f6'}]);
            };

            useEffect(() => {
                if (status !== 'PLAYING') return;
                const loop = setInterval(() => {
                    setMouthOpen(m => !m);
                    if (invincibleTimer > 0) setInvincibleTimer(t => t - 1);
                    
                    if (heldDirections.current.size > 0) {
                        const dir = Array.from(heldDirections.current).pop();
                        currentDir.current = dir;
                        setPlayer(p => {
                            let n = {...p};
                            if (dir === 'UP') n.y--; if (dir === 'DOWN') n.y++;
                            if (dir === 'LEFT') n.x--; if (dir === 'RIGHT') n.x++;
                            if (n.y>=0 && n.y<MAP_LAYOUT.length && n.x>=0 && n.x<MAP_LAYOUT[0].length && MAP_LAYOUT[n.y][n.x]!==1) {
                                // 碰撞檢查
                                setDots(prev => prev.filter(d => !(d.x === n.x && d.y === n.y)));
                                const ans = answers.find(a => a.x === n.x && a.y === n.y && Date.now() > a.activeTime);
                                if (ans) {
                                    if (ans.isCorrect) {
                                        setScore(s => s + 500); setInvincibleTimer(30); setFeedback("答對了！");
                                        setAnswers([]); setTimeout(() => { spawnQuestion(qIndex + 1); setQIndex(i => i + 1); setFeedback(null); }, 1000);
                                    } else {
                                        setHealth(h => h - 1); setFeedback("答錯了！"); setInvincibleTimer(15);
                                        setTimeout(() => setFeedback(null), 1000);
                                        if (health <= 1) setStatus('GAMEOVER');
                                    }
                                }
                                return n;
                            }
                            return p;
                        });
                    }
                }, 180);
                return () => clearInterval(loop);
            }, [status, player, answers, qIndex, health, invincibleTimer]);

            // --- 4. 補回視覺渲染 (小精靈 SVG) ---
            const renderPlayer = () => {
                const rot = { UP: '-rotate-90', DOWN: 'rotate-90', LEFT: 'rotate-180', RIGHT: 'rotate-0' }[currentDir.current];
                return (
                    <div className={`w-4 h-4 z-30 transition-transform ${rot}`}>
                        <svg viewBox="0 0 100 100" className="text-yellow-400 fill-current shadow-sm">
                            {mouthOpen ? <path d="M100,50 L50,50 L85,15 A50,50 0 1,0 85,85 Z" /> : <circle cx="50" cy="50" r="50" />}
                        </svg>
                    </div>
                );
            };

            if (status === 'MENU') return <div className="h-screen flex items-center justify-center"><button onClick={initGame} className="bg-yellow-500 p-10 rounded-3xl text-4xl font-black border-b-8 border-yellow-700 active:translate-y-1 active:border-b-0 transition-all">開始行政任務</button></div>;
            if (status === 'WIN' || status === 'GAMEOVER') return <div className="h-screen flex flex-col items-center justify-center text-white"><h1 className="text-6xl font-bold mb-4">{status==='WIN'?'任務成功':'行政失敗'}</h1><p className="text-2xl mb-8">得分：{score}</p><button onClick={()=>setStatus('MENU')} className="bg-slate-700 px-8 py-4 rounded-xl">回主選單</button></div>;

            return (
                <div className="h-screen flex flex-col items-center justify-center bg-slate-950 p-2 overflow-hidden">
                    {/* HUD */}
                    <div className="w-full max-w-md flex justify-between px-4 mb-2">
                        <div className="text-red-500 font-bold text-xl flex items-center gap-2 bg-slate-900/80 px-3 py-1 rounded-full"><Heart fill="currentColor" size={20}/> {health}</div>
                        <div className="text-yellow-400 font-bold text-xl flex items-center gap-2 bg-slate-900/80 px-3 py-1 rounded-full"><Zap fill="currentColor" size={20}/> {score}</div>
                    </div>

                    {/* Question Card */}
                    <div className="w-full max-w-md bg-slate-800 p-4 rounded-2xl border-2 border-slate-600 text-center relative mb-2 shadow-2xl">
                        <h3 className="text-xl text-white font-bold leading-tight">{QUESTIONS[qIndex]?.text}</h3>
                        {feedback && <div className="absolute inset-0 bg-blue-600 flex items-center justify-center rounded-2xl text-white font-black text-2xl animate-bounce">{feedback}</div>}
                    </div>

                    {/* Game Board */}
                    <div className="relative bg-black p-1 rounded-lg border-4 border-slate-800 shadow-2xl scale-[0.9] md:scale-100 origin-center">
                        {MAP_LAYOUT.map((row, y) => (
                            <div key={y} className="flex">
                                {row.map((cell, x) => (
                                    <div key={x} className={`w-4 h-4 md:w-5 md:h-5 flex items-center justify-center relative ${cell===1?'bg-slate-800 border-[0.1px] border-slate-700':'bg-black'}`}>
                                        {dots.some(d=>d.x===x && d.y===y) && <div className="w-1 h-1 bg-slate-700 rounded-full" />}
                                        {player.x===x && player.y===y && renderPlayer()}
                                        {ghosts.some(g=>g.x===x && g.y===y) && <div className="animate-pulse"><Ghost className="text-red-500" size={16} /></div>}
                                        {answers.find(a=>a.x===x && a.y===y) && (
                                            <div className="absolute inset-0 flex items-center justify-center">
                                                <div className="w-4 h-4 bg-blue-500 rounded-full border border-white animate-ping opacity-75" />
                                                <div className="absolute -top-6 bg-white text-black text-[10px] px-1 font-bold whitespace-nowrap rounded">{answers.find(a=>a.x===x && a.y===y).text}</div>
                                            </div>
                                        )}
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>

                    {/* 控制按鈕區 (高度優化版) */}
                    <div className="mt-4 mb-16">
                        <div className="grid grid-cols-3 gap-3 bg-slate-800/90 p-4 rounded-[40px] border border-slate-700 shadow-2xl">
                            <div />
                            <Btn dir="UP" icon={<ChevronUp size={44}/>} onD={() => heldDirections.current.add('UP')} onU={() => heldDirections.current.delete('UP')} />
                            <div />
                            <Btn dir="LEFT" icon={<ChevronLeft size={44}/>} onD={() => heldDirections.current.add('LEFT')} onU={() => heldDirections.current.delete('LEFT')} />
                            <Btn dir="DOWN" icon={<ChevronDown size={44}/>} onD={() => heldDirections.current.add('DOWN')} onU={() => heldDirections.current.delete('DOWN')} />
                            <Btn dir="RIGHT" icon={<ChevronRight size={44}/>} onD={() => heldDirections.current.add('RIGHT')} onU={() => heldDirections.current.delete('RIGHT')} />
                        </div>
                    </div>
                </div>
            );
        }

        const Btn = ({ icon, onD, onU }) => (
            <button 
                className="w-20 h-20 bg-slate-700 text-white rounded-[30px] flex items-center justify-center active:bg-yellow-500 active:scale-90 transition-all shadow-lg touch-none border-b-4 border-slate-900"
                onPointerDown={(e) => { e.preventDefault(); onD(); }}
                onPointerUp={(e) => { e.preventDefault(); onU(); }}
                onPointerLeave={(e) => { e.preventDefault(); onU(); }}
            >{icon}</button>
        );

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
