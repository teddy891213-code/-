<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>豆子行政官 - 介面優化版</title>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        body {
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            background-color: #0f172a;
            overflow: hidden;
            margin: 0;
            padding: 0;
            font-family: system-ui, -apple-system, sans-serif;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        * { -webkit-tap-highlight-color: transparent; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- SVG 圖示 (同前版本) ---
        const IconBase = ({ children, className, ...props }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className} {...props}>{children}</svg>
        );
        const Heart = (props) => <IconBase {...props}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></IconBase>;
        const Zap = (props) => <IconBase {...props}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></IconBase>;
        const Ghost = (props) => <IconBase {...props}><path d="M9 22v-2a3 3 0 0 1 3-3h0a3 3 0 0 1 3 3v2"/><path d="M9 2v2"/><path d="M15 2v2"/><path d="M12 2v2"/><path d="M5 22v-6a7 7 0 0 1 14 0v6"/><path d="M9 13h.01"/><path d="M15 13h.01"/></IconBase>;
        const Play = (props) => <IconBase {...props}><polygon points="5 3 19 12 5 21 5 3"/></IconBase>;
        const RotateCcw = (props) => <IconBase {...props}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const Trophy = (props) => <IconBase {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 1 0 5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></IconBase>;
        const Skull = (props) => <IconBase {...props}><circle cx="9" cy="12" r="1"/><circle cx="15" cy="12" r="1"/><path d="M8 20v2h8v-2"/><path d="M12.5 17l-.5-4"/><path d="M16 20a2 2 0 0 0 1.56-3.25 8 8 0 1 0-11.12 0A2 2 0 0 0 8 20"/><path d="M12 13v4"/></IconBase>;
        const Star = (props) => <IconBase {...props}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></IconBase>;
        const ChevronUp = (props) => <IconBase {...props}><polyline points="18 15 12 9 6 15"/></IconBase>;
        const ChevronDown = (props) => <IconBase {...props}><polyline points="6 9 12 15 18 9"/></IconBase>;
        const ChevronLeft = (props) => <IconBase {...props}><polyline points="15 18 9 12 15 6"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><polyline points="9 18 15 12 9 6"/></IconBase>;
        const Loader2 = (props) => <IconBase {...props}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></IconBase>;

        // --- 地圖與題目資料 (略) ---
        const MAP_LAYOUT = [[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,0,1,1,1,1,1,0,1,0,1,1,0,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,1,1,1,0,1,1,1,2,1,2,1,1,1,0,1,1,1,1],[2,2,2,1,0,1,2,2,2,9,2,2,2,1,0,1,2,2,2],[1,1,1,1,0,1,2,1,1,1,1,1,2,1,0,1,1,1,1],[1,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,1],[1,0,1,1,0,1,1,1,0,1,0,1,1,1,0,1,1,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,1,0,1,0,1,0,1,1,1,1,1,0,1,0,1,0,1,1],[1,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,0,1],[1,0,1,1,1,1,1,1,0,1,0,1,1,1,1,1,1,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]];
        const QUESTIONS = [{id: 1, text: '「購買 F-16 戰機」是誰的權限？', correctCategory: 'central', options: [{ text: '中央政府', category: 'central' },{ text: '地方政府', category: 'local' },{ text: '村里長', category: 'local_sub' },{ text: '各級學校', category: 'edu' }]},{id: 2, text: '「決定放颱風假」是誰的權限？', correctCategory: 'local', options: [{ text: '中央政府', category: 'central' },{ text: '地方政府', category: 'local' },{ text: '氣象署', category: 'central_sub' },{ text: '總統', category: 'president' }]},{id: 3, text: '「發行新台幣」是誰的權限？', correctCategory: 'central', options: [{ text: '中央政府', category: 'central' },{ text: '地方政府', category: 'local' },{ text: '一般銀行', category: 'bank' },{ text: '便利商店', category: 'store' }]}];

        function shuffle(array) { return [...array].sort(() => Math.random() - 0.5); }

        function App() {
            const [status, setStatus] = useState('MENU');
            const [player, setPlayer] = useState({ x: 9, y: 12 });
            const [ghosts, setGhosts] = useState([]);
            const [answers, setAnswers] = useState([]);
            const [qIndex, setQIndex] = useState(0);
            const [score, setScore] = useState(0);
            const [health, setHealth] = useState(3);
            const [dots, setDots] = useState([]);
            const [invincibleTimer, setInvincibleTimer] = useState(0);
            const [feedback, setFeedback] = useState(null);
            const [mouthOpen, setMouthOpen] = useState(true);
            const heldDirections = useRef(new Set());
            const currentDir = useRef('RIGHT');
            const gameLoopRef = useRef(null);

            const initGame = () => {
                setScore(0); setHealth(3); setQIndex(0); setPlayer({ x: 9, y: 12 });
                setGhosts([]); setInvincibleTimer(0); setFeedback(null);
                heldDirections.current.clear();
                fillDots(); spawnQuestion(0); setStatus('PLAYING');
            };

            const fillDots = () => {
                const newDots = [];
                MAP_LAYOUT.forEach((row, y) => row.forEach((cell, x) => { if (cell === 0) newDots.push({ x, y }); }));
                setDots(newDots);
            };

            const spawnQuestion = (index) => {
                if (index >= QUESTIONS.length) { setStatus('WIN'); return; }
                const q = QUESTIONS[index];
                const shuffledOptions = shuffle(q.options);
                const activationTime = Date.now() + 1500;
                setAnswers([{x:1,y:1},{x:17,y:1},{x:1,y:16},{x:17,y:16}].map((pos, i) => ({
                    ...pos, text: shuffledOptions[i].text, isCorrect: shuffledOptions[i].category === q.correctCategory, activeTime: activationTime
                })));
                setGhosts([{id:1,x:9,y:8,color:'#ef4444',freezeTimer:0},{id:2,x:9,y:8,color:'#3b82f6',freezeTimer:0}]);
            };

            const isValidMove = (x, y) => (y >= 0 && y < MAP_LAYOUT.length && x >= 0 && x < MAP_LAYOUT[0].length && MAP_LAYOUT[y][x] !== 1 && MAP_LAYOUT[y][x] !== 9);

            useEffect(() => {
                if (status !== 'PLAYING') return;
                gameLoopRef.current = setInterval(() => {
                    if (invincibleTimer > 0) setInvincibleTimer(t => t - 1);
                    setMouthOpen(p => !p);
                    if (heldDirections.current.size > 0) {
                        const dir = Array.from(heldDirections.current).pop();
                        currentDir.current = dir;
                        setPlayer(p => {
                            let next = {...p};
                            if (dir === 'UP') next.y--; if (dir === 'DOWN') next.y++;
                            if (dir === 'LEFT') next.x--; if (dir === 'RIGHT') next.x++;
                            return isValidMove(next.x, next.y) ? next : p;
                        });
                    }
                    // 碰撞邏輯簡化檢查
                    checkLogic();
                }, 200);
                return () => clearInterval(gameLoopRef.current);
            }, [status, player, invincibleTimer]);

            const checkLogic = () => {
                // 吃豆子
                setDots(prev => prev.filter(d => {
                    if (d.x === player.x && d.y === player.y) { setScore(s => s + 10); return false; }
                    return true;
                }));
                // 撞答案
                const ans = answers.find(a => a.x === player.x && a.y === player.y && Date.now() > a.activeTime);
                if (ans) {
                    if (ans.isCorrect) {
                        setScore(s => s + 500); setInvincibleTimer(30); setFeedback("答對了！無敵！");
                        setAnswers([]); setTimeout(() => spawnQuestion(qIndex + 1), 1000); setQIndex(i => i + 1);
                    } else {
                        setHealth(h => h - 1); setFeedback("答錯了！"); setInvincibleTimer(15);
                        if (health <= 1) setStatus('GAMEOVER');
                    }
                    setTimeout(() => setFeedback(null), 1500);
                }
            };

            const handleInputDown = (dir) => { heldDirections.current.add(dir); };
            const handleInputUp = (dir) => { heldDirections.current.delete(dir); };

            // --- Render ---
            if (status === 'MENU') return (
                <div className="flex-1 flex items-center justify-center p-4">
                    <button onClick={initGame} className="bg-yellow-500 p-8 rounded-3xl text-3xl font-black">開始遊戲</button>
                </div>
            );

            if (status === 'WIN' || status === 'GAMEOVER') return (
                <div className="flex-1 flex flex-col items-center justify-center">
                    <h1 className="text-white text-5xl mb-4 font-bold">{status === 'WIN' ? '勝利！' : '失敗'}</h1>
                    <button onClick={() => setStatus('MENU')} className="bg-slate-700 text-white p-4 rounded-xl">回主畫面</button>
                </div>
            );

            return (
                <div className="flex-1 flex flex-col items-center justify-between py-2 overflow-hidden h-screen">
                    {/* HUD */}
                    <div className="w-full max-w-md flex justify-between px-4">
                        <div className="text-red-400 font-bold text-xl flex items-center gap-1"><Heart fill="currentColor"/> x{health}</div>
                        <div className="text-yellow-400 font-bold text-xl flex items-center gap-1"><Zap fill="currentColor"/> {score}</div>
                    </div>

                    {/* Question */}
                    <div className="w-[90%] bg-slate-800 p-3 rounded-xl border-2 border-slate-600 text-center relative">
                        <h3 className="text-xl text-white font-bold">{QUESTIONS[qIndex]?.text}</h3>
                        {feedback && <div className="absolute inset-0 bg-blue-600 flex items-center justify-center rounded-xl text-white font-bold">{feedback}</div>}
                    </div>

                    {/* Game Board (縮放以符合畫面) */}
                    <div className="relative bg-black p-1 rounded-lg border-2 border-slate-700 scale-[0.85] md:scale-100 origin-center">
                        {MAP_LAYOUT.map((row, y) => (
                            <div key={y} className="flex">
                                {row.map((cell, x) => (
                                    <div key={x} className={`w-5 h-5 flex items-center justify-center ${cell === 1 ? 'bg-slate-800' : 'bg-black'}`}>
                                        {dots.some(d => d.x === x && d.y === y) && <div className="w-1 h-1 bg-slate-600 rounded-full" />}
                                        {player.x === x && player.y === y && <div className="w-4 h-4 bg-yellow-400 rounded-full" />}
                                        {answers.find(a => a.x === x && a.y === y) && <div className="w-4 h-4 bg-blue-500 rounded-full animate-pulse border border-white" />}
                                        {ghosts.some(g => g.x === x && g.y === y) && <div className="w-4 h-4 bg-red-500 rounded-sm" />}
                                    </div>
                                ))}
                            </div>
                        ))}
                    </div>

                    {/* 上移的控制按鈕 (關鍵點：提升佈局位置) */}
                    <div className="w-full flex justify-center pb-4">
                        <div className="grid grid-cols-3 gap-2 bg-slate-800/80 p-3 rounded-2xl">
                            <div />
                            <Btn dir="UP" icon={<ChevronUp size={36}/>} onDown={handleInputDown} onUp={handleInputUp} />
                            <div />
                            <Btn dir="LEFT" icon={<ChevronLeft size={36}/>} onDown={handleInputDown} onUp={handleInputUp} />
                            <Btn dir="DOWN" icon={<ChevronDown size={36}/>} onDown={handleInputDown} onUp={handleInputUp} />
                            <Btn dir="RIGHT" icon={<ChevronRight size={36}/>} onDown={handleInputDown} onUp={handleInputUp} />
                        </div>
                    </div>
                </div>
            );
        }

        const Btn = ({ dir, icon, onDown, onUp }) => (
            <button 
                className="w-16 h-16 bg-slate-600 rounded-xl flex items-center justify-center active:bg-yellow-500 active:scale-90 transition-all touch-none"
                onPointerDown={(e) => { e.preventDefault(); onDown(dir); }}
                onPointerUp={(e) => { e.preventDefault(); onUp(dir); }}
                onPointerLeave={(e) => { e.preventDefault(); onUp(dir); }}
            >{icon}</button>
        );

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
